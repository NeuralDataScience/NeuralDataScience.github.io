
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>7.2. Large Scale Single Cell Electrophysiology &amp; Behavior &#8212; A Hands-On Guide to Neural Data Science</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7.3. Identifying Cells with Optogenetics" href="Identifying_Cells_with_Optogenetics.html" />
    <link rel="prev" title="7.1. Downloading Large Scale Data" href="Downloading_Large_Scale_Data.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/brainz.jpeg" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">A Hands-On Guide to Neural Data Science</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../landing_page.html">
   A Hands-On Guide to Neural Data Science
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_1/Neural_Data_Science.html">
   1. Neural Data Science
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_2/Data_Science_In_Python.html">
   2. Data Science in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_3/Statistical_Concepts.html">
   3. Statistical Concepts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_4/Neurodata_Without_Borders.html">
   4. Neurodata Without Borders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_5/Single-Cell_Electrophysiology.html">
   5. Single-Cell Electrophysiology
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_6/Two_Photon_Imaging.html">
   6. Two Photon Imaging
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="reference internal" href="Large_Scale_Electrophysiology.html">
   7. Large Scale Electrophysiology
  </a>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="Downloading_Large_Scale_Data.html">
     7.1. Downloading Large Scale Data
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     7.2. Large Scale Single Cell Electrophysiology &amp; Behavior
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Identifying_Cells_with_Optogenetics.html">
     7.3. Identifying Cells with Optogenetics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Correlations.html">
     7.4. Spike Sorting Neuropixels Data
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_8/Connectivity_Atlas.html">
   8. Allen Mouse Brain Connectivity Atlas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_9/Brain_Imaging_Data_Structures.html">
   9. Brain Imaging Data Structures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_10/Text_Analyses_of_Neuroscience_Literature.html">
   10. Text Analyses of Neuroscience Literature
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_11/Approaches_to_Analyzing_Large_Datasets.html">
   11. Approaches to Analyzing Large Datasets
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/Chapter_7/Large_Scale_Electrophysiology_and_Behavior.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/NeuralDataScience/NeuralDataScience.github.io/master?urlpath=tree/Chapter_7/Large_Scale_Electrophysiology_and_Behavior.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/NeuralDataScience/NeuralDataScience.github.io/blob/master/Chapter_7/Large_Scale_Electrophysiology_and_Behavior.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#units">
   7.2.1. Units
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#firing-rate">
   7.2.2. Firing Rate
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#running-speed">
   7.2.3. Running Speed
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="large-scale-single-cell-electrophysiology-behavior">
<h1><span class="section-number">7.2. </span>Large Scale Single Cell Electrophysiology &amp; Behavior<a class="headerlink" href="#large-scale-single-cell-electrophysiology-behavior" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># This will ensure that the AllenSDK is installed.</span>
<span class="c1"># If not, it will install it for you.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">allensdk</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;allensdk already installed.&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="o">!</span>pip install allensdk
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>allensdk already installed.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import the Neuropixels Cache</span>
<span class="kn">from</span> <span class="nn">allensdk.brain_observatory.ecephys.ecephys_project_cache</span> <span class="kn">import</span> <span class="n">EcephysProjectCache</span>
<span class="kn">from</span> <span class="nn">allensdk.brain_observatory.ecephys.ecephys_project_api</span> <span class="kn">import</span> <span class="n">EcephysProjectWarehouseApi</span>
<span class="kn">from</span> <span class="nn">allensdk.brain_observatory.ecephys.ecephys_project_api.rma_engine</span> <span class="kn">import</span> <span class="n">RmaEngine</span>

<span class="c1"># Import 2-Photon Cache</span>
<span class="kn">from</span> <span class="nn">allensdk.core.brain_observatory_cache</span> <span class="kn">import</span> <span class="n">BrainObservatoryCache</span>

<span class="c1"># Assign where neuropixels data and 2-photon data will be stored</span>
<span class="n">manifest_path</span> <span class="o">=</span> <span class="s1">&#39;manifest.json&#39;</span> 
<span class="n">manifest_path2</span> <span class="o">=</span> <span class="s1">&#39;manifest2.json&#39;</span>

<span class="c1"># Create the EcephysProjectCache object</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">EcephysProjectCache</span><span class="p">(</span><span class="n">manifest</span><span class="o">=</span><span class="n">manifest_path</span><span class="p">,</span>
                            <span class="n">fetch_api</span><span class="o">=</span><span class="n">EcephysProjectWarehouseApi</span><span class="p">(</span><span class="n">RmaEngine</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;http&quot;</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;api.brain-map.org&quot;</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)))</span>          

<span class="c1"># Create an instance of the Brain Observatory cache</span>
<span class="n">boc</span> <span class="o">=</span> <span class="n">BrainObservatoryCache</span><span class="p">(</span><span class="n">manifest_file</span><span class="o">=</span> <span class="n">manifest_path2</span><span class="p">)</span>

<span class="c1"># Download our session data </span>
<span class="n">session</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_session_data</span><span class="p">(</span><span class="mi">719161530</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Session downloaded.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Session downloaded.
</pre></div>
</div>
</div>
</div>
<div class="section" id="units">
<h2><span class="section-number">7.2.1. </span>Units<a class="headerlink" href="#units" title="Permalink to this headline">¶</a></h2>
<p>Now that we have downloaded the session file, we can begin to explore our session object. The <code class="docutils literal notranslate"><span class="pre">units</span></code> property of our session object returns a dataframe that contains the recorded activity of our individual neurons. There are many metrics stored within <code class="docutils literal notranslate"><span class="pre">units</span></code> that can be used in your potential analyses. Some key metrics include:</p>
<ul class="simple">
<li><p><strong>firing rate</strong>: mean spike rate during the entire session</p></li>
<li><p><strong>presence ratio</strong>: fraction of session when spikes are present</p></li>
<li><p><strong>ISI violations</strong>: rate of refractory period violations</p></li>
<li><p><strong>Isolation distances</strong>: distance to nearest cluster in Mihalanobis space</p></li>
<li><p><strong>d’</strong>: classification accuracy based on LDA</p></li>
<li><p><strong>SNR</strong>: signal to noise ratio</p></li>
<li><p><strong>Maximum drift</strong>: Maximum change in spike depth during recording</p></li>
<li><p><strong>Cumulative drift</strong>: Cumulative change in spike depth during recording</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">units_df</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">units</span>
<span class="n">units_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>waveform_duration</th>
      <th>cluster_id</th>
      <th>peak_channel_id</th>
      <th>cumulative_drift</th>
      <th>amplitude_cutoff</th>
      <th>snr</th>
      <th>waveform_recovery_slope</th>
      <th>isolation_distance</th>
      <th>nn_miss_rate</th>
      <th>silhouette_score</th>
      <th>...</th>
      <th>ecephys_structure_id</th>
      <th>ecephys_structure_acronym</th>
      <th>anterior_posterior_ccf_coordinate</th>
      <th>dorsal_ventral_ccf_coordinate</th>
      <th>left_right_ccf_coordinate</th>
      <th>probe_description</th>
      <th>location</th>
      <th>probe_sampling_rate</th>
      <th>probe_lfp_sampling_rate</th>
      <th>probe_has_lfp_data</th>
    </tr>
    <tr>
      <th>unit_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>950916730</th>
      <td>0.315913</td>
      <td>0</td>
      <td>850252273</td>
      <td>421.99</td>
      <td>0.010911</td>
      <td>2.408535</td>
      <td>-0.072013</td>
      <td>115.066739</td>
      <td>0.001010</td>
      <td>NaN</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8369.0</td>
      <td>3658.0</td>
      <td>6985.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916822</th>
      <td>0.233501</td>
      <td>7</td>
      <td>850252319</td>
      <td>294.57</td>
      <td>0.000025</td>
      <td>3.769478</td>
      <td>-0.212549</td>
      <td>160.983322</td>
      <td>0.000000</td>
      <td>0.115187</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8288.0</td>
      <td>3464.0</td>
      <td>7039.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916845</th>
      <td>0.192295</td>
      <td>9</td>
      <td>850252323</td>
      <td>270.88</td>
      <td>0.023245</td>
      <td>3.087942</td>
      <td>-0.216281</td>
      <td>77.035531</td>
      <td>0.002380</td>
      <td>0.170339</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8281.0</td>
      <td>3448.0</td>
      <td>7044.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916856</th>
      <td>0.233501</td>
      <td>10</td>
      <td>850252325</td>
      <td>219.19</td>
      <td>0.011552</td>
      <td>2.743504</td>
      <td>-0.087931</td>
      <td>291.708582</td>
      <td>0.047256</td>
      <td>0.141643</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8277.0</td>
      <td>3440.0</td>
      <td>7046.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916892</th>
      <td>0.343384</td>
      <td>13</td>
      <td>850252329</td>
      <td>558.87</td>
      <td>0.029890</td>
      <td>2.428990</td>
      <td>-0.005812</td>
      <td>41.639547</td>
      <td>0.000338</td>
      <td>0.180152</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8270.0</td>
      <td>3424.0</td>
      <td>7051.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 89 columns</p>
</div></div></div>
</div>
<p>Just like we did before in our sessions dataframe, we can return the brain structures that our session’s data was recorded from as well as how many neurons were recorded per brain area.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;ecephys_structure_acronym&#39;</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Available Brain Structures:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">units_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Brain Structure Frequency:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">units_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Available Brain Structures:
[&#39;APN&#39; &#39;DG&#39; &#39;CA1&#39; &#39;VISam&#39; &#39;TH&#39; &#39;Eth&#39; &#39;POL&#39; &#39;LP&#39; &#39;VISpm&#39; &#39;NOT&#39; &#39;SUB&#39; &#39;VISp&#39;
 &#39;grey&#39; &#39;VL&#39; &#39;CA3&#39; &#39;VISl&#39; &#39;PO&#39; &#39;VPM&#39; &#39;LGd&#39; &#39;VISal&#39; &#39;VISrl&#39;]

 Brain Structure Frequency:
APN      176
CA1      108
LGd       71
POL       55
VISp      52
SUB       42
VISl      40
VISam     37
LP        28
VPM       24
grey      19
VISpm     18
NOT       16
CA3       14
DG        14
VISrl     10
TH         9
VISal      9
VL         7
PO         5
Eth        1
Name: ecephys_structure_acronym, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>To ensure that the recordings we use in our analysis are all of good quality, we will filter the data according to the signal-to-noise ratio (<code class="docutils literal notranslate"><span class="pre">snr</span></code>) and the <code class="docutils literal notranslate"><span class="pre">ISI_Violations</span></code> of our neurons. Below we will plot the distributions of both.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Signal to noise distribution</span>
<span class="n">col_1</span> <span class="o">=</span> <span class="s1">&#39;snr&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">units_df</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of SNR&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Signal to Noise Ratio&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Large_Scale_Electrophysiology_and_Behavior_9_0.png" src="../_images/Large_Scale_Electrophysiology_and_Behavior_9_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ISI distribution </span>
<span class="n">col_2</span> <span class="o">=</span> <span class="s1">&#39;isi_violations&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">units_df</span><span class="p">[</span><span class="n">col_2</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of ISI Violations&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Rate of Refractory Period Violations&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Large_Scale_Electrophysiology_and_Behavior_10_0.png" src="../_images/Large_Scale_Electrophysiology_and_Behavior_10_0.png" />
</div>
</div>
<p>For the purposes of this tutorial, we will use <code class="docutils literal notranslate"><span class="pre">snr</span></code> values greater than 1 and <code class="docutils literal notranslate"><span class="pre">ISI_violation</span></code> values less than 0.1, define our quality neurons.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">good_snr</span> <span class="o">=</span> <span class="n">units_df</span><span class="p">[</span><span class="n">units_df</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span>
<span class="n">low_isi</span> <span class="o">=</span> <span class="n">units_df</span><span class="p">[</span><span class="n">units_df</span><span class="p">[</span><span class="s1">&#39;isi_violations&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">]</span>
<span class="n">combined_df</span> <span class="o">=</span> <span class="n">low_isi</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">good_snr</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of Recordings with good SNR and Low ISI:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">combined_df</span><span class="p">))</span>
<span class="n">combined_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of Recordings with good SNR and Low ISI:
555
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>waveform_duration</th>
      <th>cluster_id</th>
      <th>peak_channel_id</th>
      <th>cumulative_drift</th>
      <th>amplitude_cutoff</th>
      <th>snr</th>
      <th>waveform_recovery_slope</th>
      <th>isolation_distance</th>
      <th>nn_miss_rate</th>
      <th>silhouette_score</th>
      <th>...</th>
      <th>ecephys_structure_id</th>
      <th>ecephys_structure_acronym</th>
      <th>anterior_posterior_ccf_coordinate</th>
      <th>dorsal_ventral_ccf_coordinate</th>
      <th>left_right_ccf_coordinate</th>
      <th>probe_description</th>
      <th>location</th>
      <th>probe_sampling_rate</th>
      <th>probe_lfp_sampling_rate</th>
      <th>probe_has_lfp_data</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.315913</td>
      <td>0</td>
      <td>850252273</td>
      <td>421.99</td>
      <td>0.010911</td>
      <td>2.408535</td>
      <td>-0.072013</td>
      <td>115.066739</td>
      <td>0.001010</td>
      <td>NaN</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8369.0</td>
      <td>3658.0</td>
      <td>6985.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.233501</td>
      <td>7</td>
      <td>850252319</td>
      <td>294.57</td>
      <td>0.000025</td>
      <td>3.769478</td>
      <td>-0.212549</td>
      <td>160.983322</td>
      <td>0.000000</td>
      <td>0.115187</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8288.0</td>
      <td>3464.0</td>
      <td>7039.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.233501</td>
      <td>10</td>
      <td>850252325</td>
      <td>219.19</td>
      <td>0.011552</td>
      <td>2.743504</td>
      <td>-0.087931</td>
      <td>291.708582</td>
      <td>0.047256</td>
      <td>0.141643</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8277.0</td>
      <td>3440.0</td>
      <td>7046.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.467002</td>
      <td>24</td>
      <td>850252351</td>
      <td>154.34</td>
      <td>0.003052</td>
      <td>2.084643</td>
      <td>-0.059217</td>
      <td>179.310426</td>
      <td>0.013169</td>
      <td>0.102770</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8229.0</td>
      <td>3331.0</td>
      <td>7079.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.192295</td>
      <td>21</td>
      <td>850252349</td>
      <td>184.14</td>
      <td>0.003787</td>
      <td>2.805553</td>
      <td>-0.221815</td>
      <td>68.033790</td>
      <td>0.003977</td>
      <td>0.054381</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8232.0</td>
      <td>3339.0</td>
      <td>7077.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 89 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="firing-rate">
<h2><span class="section-number">7.2.2. </span>Firing Rate<a class="headerlink" href="#firing-rate" title="Permalink to this headline">¶</a></h2>
<p><em>Explaining Firing Rate</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;firing_rate&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ecephys_structure_acronym&#39;</span><span class="p">,</span><span class="n">data</span> <span class="o">=</span> <span class="n">combined_df</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Violinplot of Firing Rates across Brain Structures&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Large_Scale_Electrophysiology_and_Behavior_16_0.png" src="../_images/Large_Scale_Electrophysiology_and_Behavior_16_0.png" />
</div>
</div>
</div>
<div class="section" id="running-speed">
<h2><span class="section-number">7.2.3. </span>Running Speed<a class="headerlink" href="#running-speed" title="Permalink to this headline">¶</a></h2>
<p><em>explain run speed and 2 photon/neuropixels connectivity</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rs</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">running_speed</span>
<span class="n">rs</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start_time</th>
      <th>end_time</th>
      <th>velocity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>29.77937</td>
      <td>29.79390</td>
      <td>-0.375017</td>
    </tr>
    <tr>
      <th>1</th>
      <td>29.79390</td>
      <td>29.81039</td>
      <td>3.825516</td>
    </tr>
    <tr>
      <th>2</th>
      <td>29.82680</td>
      <td>29.84451</td>
      <td>-0.942946</td>
    </tr>
    <tr>
      <th>3</th>
      <td>29.84451</td>
      <td>29.85961</td>
      <td>-1.594519</td>
    </tr>
    <tr>
      <th>4</th>
      <td>29.87652</td>
      <td>29.89318</td>
      <td>1.059689</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">rs</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span>

<span class="c1"># Plot it</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (seconds)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Speed&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Large_Scale_Electrophysiology_and_Behavior_20_0.png" src="../_images/Large_Scale_Electrophysiology_and_Behavior_20_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assign previous container ID</span>
<span class="n">exp_container_id</span> <span class="o">=</span> <span class="mi">627823571</span>
<span class="n">stim</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;drifting_gratings&#39;</span><span class="p">]</span>

<span class="c1"># Get experiments for our container id and stimuli of interest</span>
<span class="n">experiments</span> <span class="o">=</span> <span class="n">boc</span><span class="o">.</span><span class="n">get_ophys_experiments</span><span class="p">(</span><span class="n">experiment_container_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_container_id</span><span class="p">],</span>
                                     <span class="n">stimuli</span> <span class="o">=</span> <span class="n">stim</span><span class="p">)</span>

<span class="c1"># Assign the experiment id </span>
<span class="n">experiment_id</span> <span class="o">=</span> <span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="n">experiment_data</span> <span class="o">=</span> <span class="n">boc</span><span class="o">.</span><span class="n">get_ophys_experiment_data</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">)</span>

<span class="c1"># Assign timestamps and deltaF/F</span>
<span class="n">ts</span><span class="p">,</span> <span class="n">dff</span> <span class="o">=</span> <span class="n">experiment_data</span><span class="o">.</span><span class="n">get_dff_traces</span><span class="p">()</span>
<span class="n">dff_mean</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dff</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">dff_mean</span><span class="o">.</span><span class="n">shape</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data acquired.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data acquired.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bin_size</span> <span class="o">=</span> <span class="mi">5</span> 
<span class="n">bin_stamps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ts</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">bin_size</span><span class="p">)</span>
<span class="n">num_bins</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_stamps</span><span class="p">)</span>

<span class="n">run_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>
<span class="n">response_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">num_bins</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bins</span><span class="p">):</span>
    
    <span class="c1"># Get the values within our time bin and take a mean</span>
    <span class="n">run_bin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">([(</span><span class="n">ts</span><span class="o">&gt;</span><span class="n">i</span><span class="o">*</span><span class="n">bin_size</span><span class="p">),</span> <span class="p">(</span><span class="n">ts</span><span class="o">&lt;</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">bin_size</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> 
    <span class="n">response_bin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dff_mean</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">([(</span><span class="n">ts</span><span class="o">&gt;</span><span class="n">i</span><span class="o">*</span><span class="n">bin_size</span><span class="p">),</span> <span class="p">(</span><span class="n">ts</span><span class="o">&lt;</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">bin_size</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">  File</span><span class="nn"> &quot;&lt;ipython-input-13-1ef7f4665be5&gt;&quot;</span><span class="gt">, line </span><span class="mi">12</span>
    <span class="n">response_bin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dff_mean</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">([(</span><span class="n">ts</span><span class="o">&gt;</span><span class="n">i</span><span class="o">*</span><span class="n">bin_size</span><span class="p">),</span> <span class="p">(</span><span class="n">ts</span><span class="o">&lt;</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">bin_size</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
               <span class="o">^</span>
<span class="ne">SyntaxError</span>: invalid syntax
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Chapter_7"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="Downloading_Large_Scale_Data.html" title="previous page"><span class="section-number">7.1. </span>Downloading Large Scale Data</a>
    <a class='right-next' id="next-link" href="Identifying_Cells_with_Optogenetics.html" title="next page"><span class="section-number">7.3. </span>Identifying Cells with Optogenetics</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Victor Magdaleno-Garcia<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>