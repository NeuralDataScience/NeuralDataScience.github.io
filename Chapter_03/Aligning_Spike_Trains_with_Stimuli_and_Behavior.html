
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3.3. Aligning Spike Trains with Visual Stimuli and Behavior &#8212; Teaching &amp; Learning with NWB Datasets</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.4. Identifying Cells with Optogenetics" href="Identifying_Cells_with_Optogenetics.html" />
    <link rel="prev" title="3.2. Obtaining Raw Electrophysiology Data from the AllenSDK" href="Obtaining_Raw_Electrophysiology_Data.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/nwb_learning.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Teaching & Learning with NWB Datasets</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../landing_page.html">
   Teaching and Learning with NWB Datasets
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_01/Data_Science_In_Python.html">
   1. Data Science in Python
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_01/NumPy.html">
     1.3. NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_01/Pandas.html">
     1.4. Pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_01/SciPy.html">
     1.5. SciPy
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_02/Obtaining_and_Working_with_NWB_Datasets.html">
   2. Obtaining and Working with NWB Datasets
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_02/Obtaining_Datasets_with_DANDI.html">
     2.1. Obtaining Datasets with DANDI
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_02/Working_with_NWB_format_in_Python.html">
     2.2. Working with NWB in Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_02/Chapter_2_ProblemSet.html">
     2.3. Chapter 2 Problem Set
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="Large_Scale_Electrophysiology.html">
   3. Large Scale Electrophysiology
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="Visualizing_Large_Scale_Recordings.html">
     3.1. Sample Visualizations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Obtaining_Raw_Electrophysiology_Data.html">
     3.2. Obtaining Raw Electrophysiology Data from the AllenSDK
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     3.3. Aligning Spike Trains with Visual Stimuli and Behavior
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Identifying_Cells_with_Optogenetics.html">
     3.4. Identifying Cells with Optogenetics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Chapter_3_ProblemSet.html">
     3.5. Chapter 3 Problem Set
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_04/Single-Cell_Electrophysiology.html">
   4. Single-Cell Electrophysiology
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_04/Obtaining_Data_For_Single_Cells.html">
     4.1. Obtaining Data for Single Cells
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_04/Analyzing_Computed_Features.html">
     4.2. Analyzing Computed Features
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_05/Two_Photon_Imaging.html">
   5. Two Photon Imaging
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_05/Retrieving_Brain_Observatory_Data.html">
     5.1. Retrieving Calcium Imaging Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_05/Analyzing_Two_Photon_Data.html">
     5.2. Analyzing Two Photon Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_05/Correlations_in_Two_Photon_Data.html">
     5.3. Correlations in Two Photon Data
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/Chapter_03/Aligning_Spike_Trains_with_Stimuli_and_Behavior.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/NeuralDataScience/NeuralDataScience.github.io/master?urlpath=tree/Chapter_03/Aligning_Spike_Trains_with_Stimuli_and_Behavior.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/NeuralDataScience/NeuralDataScience.github.io/blob/master/Chapter_03/Aligning_Spike_Trains_with_Stimuli_and_Behavior.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#spike-times">
   3.3.1. Spike Times
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#stimulus-presentations">
   3.3.2. Stimulus Presentations
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-the-spykes-module-to-plot-electrophysiology-data">
   3.3.3. Using the Spykes module to plot electrophysiology data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#running-speed">
   3.3.4. Running Speed
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="aligning-spike-trains-with-visual-stimuli-and-behavior">
<h1><span class="section-number">3.3. </span>Aligning Spike Trains with Visual Stimuli and Behavior<a class="headerlink" href="#aligning-spike-trains-with-visual-stimuli-and-behavior" title="Permalink to this headline">¶</a></h1>
<p>In the previous section, we learned how to access metadata about the Allen Institute’s Visual Coding and download a Neuropixels dataset. Here, we’ll pull in additional information about the visual stimuli and the behavior of the mouse in order to see if we can explain our neural activity in terms of either of these.</p>
<p>In this notebook, we’ll work with the same data you worked with in Chapter 3.1. If you did not work through that notebook, the cells below will not work for you.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import necessary packages </span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">allensdk.brain_observatory.ecephys.ecephys_project_cache</span> <span class="kn">import</span> <span class="n">EcephysProjectCache</span>

<span class="c1"># Import packages necessary to plot behavior</span>
<span class="kn">import</span> <span class="nn">allensdk.brain_observatory.ecephys.visualization</span> <span class="k">as</span> <span class="nn">ecvis</span>
<span class="kn">from</span> <span class="nn">allensdk.brain_observatory.visualization</span> <span class="kn">import</span> <span class="n">plot_running_speed</span>
<span class="kn">from</span> <span class="nn">spykes.plot.neurovis</span> <span class="kn">import</span> <span class="n">NeuroVis</span>
<span class="kn">from</span> <span class="nn">spykes.plot.popvis</span> <span class="kn">import</span> <span class="n">PopVis</span>

<span class="c1"># Create the EcephysProjectCache object</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">EcephysProjectCache</span><span class="p">(</span><span class="n">manifest</span><span class="o">=</span><span class="s1">&#39;manifest.json&#39;</span><span class="p">)</span>                            
<span class="n">session</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_session_data</span><span class="p">(</span><span class="mi">719161530</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Session data obtained.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:root:downloading a 2929.156MiB file from http://api.brain-map.org//api/v2/well_known_file_download/1026124034
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"version_major": 2, "version_minor": 0, "model_id": "bf547fa80eda45a5ab57b90d343ffb70"}
</script><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">OSError</span><span class="g g-Whitespace">                                   </span>Traceback (most recent call last)
<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/api/warehouse_cache/caching_utilities.py</span> in <span class="ni">call_caching</span><span class="nt">(fetch, write, read, pre_write, cleanup, lazy, num_tries, failure_message)</span>
<span class="g g-Whitespace">    </span><span class="mi">103</span>             <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading data from cache&quot;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">104</span>             <span class="k">return</span> <span class="n">read</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/ecephys/ecephys_project_cache.py</span> in <span class="ni">read</span><span class="nt">(_path)</span>
<span class="g g-Whitespace">    </span><span class="mi">347</span>         <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">_path</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">348</span>             <span class="n">session_api</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_nwb_api_for_session</span><span class="p">(</span><span class="n">_path</span><span class="p">,</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">filter_by_validity</span><span class="p">,</span> <span class="o">**</span><span class="n">unit_filter_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">349</span>             <span class="k">return</span> <span class="n">EcephysSession</span><span class="p">(</span><span class="n">api</span><span class="o">=</span><span class="n">session_api</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/ecephys/ecephys_project_cache.py</span> in <span class="ni">_build_nwb_api_for_session</span><span class="nt">(self, path, session_id, filter_by_validity, **unit_filter_kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">374</span>             <span class="n">filter_by_validity</span><span class="o">=</span><span class="n">filter_by_validity</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">375</span>             <span class="o">**</span><span class="n">unit_filter_kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">376</span>         <span class="p">)</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/ecephys/ecephys_session_api/ecephys_nwb_session_api.py</span> in <span class="ni">__init__</span><span class="nt">(self, path, probe_lfp_paths, additional_unit_metrics, external_channel_columns, **kwargs)</span>
<span class="g g-Whitespace">     </span><span class="mi">65</span>                 <span class="n">warning_msg</span><span class="o">=</span><span class="p">(</span>
<span class="ne">---&gt; </span><span class="mi">66</span>                     <span class="sa">f</span><span class="s2">&quot;It looks like the Visual Coding Neuropixels nwbfile &quot;</span>
<span class="g g-Whitespace">     </span><span class="mi">67</span>                     <span class="sa">f</span><span class="s2">&quot;you are trying to access (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">)&quot;</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/nwb/__init__.py</span> in <span class="ni">check_nwbfile_version</span><span class="nt">(nwbfile_path, desired_minimum_version, warning_msg)</span>
<span class="g g-Whitespace">     </span><span class="mi">57</span>                           <span class="n">warning_msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="ne">---&gt; </span><span class="mi">58</span>     <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">nwbfile_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span>         <span class="c1"># nwb 2.x files store version as an attribute</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/h5py/_hl/files.py</span> in <span class="ni">__init__</span><span class="nt">(self, name, mode, driver, libver, userblock_size, swmr, rdcc_nslots, rdcc_nbytes, rdcc_w0, track_order, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">407</span>                                <span class="n">fapl</span><span class="p">,</span> <span class="n">fcpl</span><span class="o">=</span><span class="n">make_fcpl</span><span class="p">(</span><span class="n">track_order</span><span class="o">=</span><span class="n">track_order</span><span class="p">),</span>
<span class="ne">--&gt; </span><span class="mi">408</span>                                <span class="n">swmr</span><span class="o">=</span><span class="n">swmr</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">409</span> 

<span class="nn">~/anaconda3/lib/python3.7/site-packages/h5py/_hl/files.py</span> in <span class="ni">make_fid</span><span class="nt">(name, mode, userblock_size, fapl, fcpl, swmr)</span>
<span class="g g-Whitespace">    </span><span class="mi">172</span>             <span class="n">flags</span> <span class="o">|=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">ACC_SWMR_READ</span>
<span class="ne">--&gt; </span><span class="mi">173</span>         <span class="n">fid</span> <span class="o">=</span> <span class="n">h5f</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">fapl</span><span class="o">=</span><span class="n">fapl</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">174</span>     <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;r+&#39;</span><span class="p">:</span>

<span class="nn">h5py/_objects.pyx</span> in <span class="ni">h5py._objects.with_phil.wrapper</span><span class="nt">()</span>

<span class="nn">h5py/_objects.pyx</span> in <span class="ni">h5py._objects.with_phil.wrapper</span><span class="nt">()</span>

<span class="nn">h5py/h5f.pyx</span> in <span class="ni">h5py.h5f.open</span><span class="nt">()</span>

<span class="ne">OSError</span>: Unable to open file (truncated file: eof = 5754880, sblock-&gt;base_addr = 0, stored_eof = 3071442940)

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">e2a5cfe033c4</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span> <span class="c1"># Create the EcephysProjectCache object</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">EcephysProjectCache</span><span class="p">(</span><span class="n">manifest</span><span class="o">=</span><span class="s1">&#39;manifest.json&#39;</span><span class="p">)</span>
<span class="ne">---&gt; </span><span class="mi">16</span> <span class="n">session</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_session_data</span><span class="p">(</span><span class="mi">719161530</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Session data obtained.&#39;</span><span class="p">)</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/ecephys/ecephys_project_cache.py</span> in <span class="ni">get_session_data</span><span class="nt">(self, session_id, filter_by_validity, **unit_filter_kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">354</span>             <span class="bp">self</span><span class="o">.</span><span class="n">stream_writer</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">355</span>             <span class="n">read</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">356</span>             <span class="n">num_tries</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_tries</span>
<span class="g g-Whitespace">    </span><span class="mi">357</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">358</span> 

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/api/warehouse_cache/caching_utilities.py</span> in <span class="ni">one_file_call_caching</span><span class="nt">(path, fetch, write, read, pre_write, cleanup, lazy, num_tries, failure_message)</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span>         <span class="n">lazy</span><span class="o">=</span><span class="n">lazy</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span>         <span class="n">num_tries</span><span class="o">=</span><span class="n">num_tries</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">187</span>         <span class="n">failure_message</span><span class="o">=</span><span class="n">failure_message</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span>     <span class="p">)</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/api/warehouse_cache/caching_utilities.py</span> in <span class="ni">call_caching</span><span class="nt">(fetch, write, read, pre_write, cleanup, lazy, num_tries, failure_message)</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>             <span class="n">lazy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span>             <span class="n">num_tries</span><span class="o">=</span><span class="n">num_tries</span><span class="p">,</span>
<span class="ne">--&gt; </span><span class="mi">137</span>             <span class="n">failure_message</span><span class="o">=</span><span class="n">failure_message</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">138</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">139</span> 

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/api/warehouse_cache/caching_utilities.py</span> in <span class="ni">call_caching</span><span class="nt">(fetch, write, read, pre_write, cleanup, lazy, num_tries, failure_message)</span>
<span class="g g-Whitespace">     </span><span class="mi">98</span>                 <span class="n">data</span> <span class="o">=</span> <span class="n">pre_write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">99</span>             <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Writing data to cache&quot;</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">100</span>             <span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">101</span> 
<span class="g g-Whitespace">    </span><span class="mi">102</span>         <span class="k">if</span> <span class="n">read</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/api/warehouse_cache/caching_utilities.py</span> in <span class="ni">safe_write</span><span class="nt">(data)</span>
<span class="g g-Whitespace">    </span><span class="mi">169</span>     <span class="k">def</span> <span class="nf">safe_write</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Q</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">170</span>         <span class="n">Manifest</span><span class="o">.</span><span class="n">safe_make_parent_dirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">171</span>         <span class="n">write</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">172</span> 
<span class="g g-Whitespace">    </span><span class="mi">173</span>     <span class="k">if</span> <span class="n">read</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/ecephys/ecephys_project_api/http_engine.py</span> in <span class="ni">write_bytes</span><span class="nt">(path, stream)</span>
<span class="g g-Whitespace">     </span><span class="mi">85</span>     <span class="nd">@staticmethod</span>
<span class="g g-Whitespace">     </span><span class="mi">86</span>     <span class="k">def</span> <span class="nf">write_bytes</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stream</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]):</span>
<span class="ne">---&gt; </span><span class="mi">87</span>         <span class="n">write_from_stream</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">88</span> 
<span class="g g-Whitespace">     </span><span class="mi">89</span> 

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/ecephys/ecephys_project_api/http_engine.py</span> in <span class="ni">write_from_stream</span><span class="nt">(path, stream)</span>
<span class="g g-Whitespace">    </span><span class="mi">232</span>     <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">233</span><span class="s2">     with open(path, &quot;wb&quot;) as fil:</span>
<span class="ne">--&gt; </span><span class="mi">234</span><span class="s2">         for chunk in stream:</span>
<span class="g g-Whitespace">    </span><span class="mi">235</span><span class="s2">             fil.write(chunk)</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/ecephys/ecephys_project_api/http_engine.py</span> in <span class="ni">stream</span><span class="nt">(self, route)</span>
<span class="g g-Whitespace">     </span><span class="mi">74</span><span class="s2">         progress = tqdm( unit=&quot;B&quot;, total=response_b, unit_scale=True,  desc=&quot;Downloading&quot;)</span>
<span class="g g-Whitespace">     </span><span class="mi">75</span><span class="s2"> </span>
<span class="ne">---&gt; </span><span class="mi">76</span><span class="s2">         for chunk in response.iter_content(self.chunksize):</span>
<span class="g g-Whitespace">     </span><span class="mi">77</span><span class="s2">             if chunk: # filter out keep-alive new chunks</span>
<span class="g g-Whitespace">     </span><span class="mi">78</span><span class="s2">                 progress.update(len(chunk))</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/requests/models.py</span> in <span class="ni">generate</span><span class="nt">()</span>
<span class="g g-Whitespace">    </span><span class="mi">751</span><span class="s2">             if hasattr(self.raw, &#39;stream&#39;):</span>
<span class="g g-Whitespace">    </span><span class="mi">752</span><span class="s2">                 try:</span>
<span class="ne">--&gt; </span><span class="mi">753</span><span class="s2">                     for chunk in self.raw.stream(chunk_size, decode_content=True):</span>
<span class="g g-Whitespace">    </span><span class="mi">754</span><span class="s2">                         yield chunk</span>
<span class="g g-Whitespace">    </span><span class="mi">755</span><span class="s2">                 except ProtocolError as e:</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/urllib3/response.py</span> in <span class="ni">stream</span><span class="nt">(self, amt, decode_content)</span>
<span class="g g-Whitespace">    </span><span class="mi">574</span><span class="s2">         else:</span>
<span class="g g-Whitespace">    </span><span class="mi">575</span><span class="s2">             while not is_fp_closed(self._fp):</span>
<span class="ne">--&gt; </span><span class="mi">576</span><span class="s2">                 data = self.read(amt=amt, decode_content=decode_content)</span>
<span class="g g-Whitespace">    </span><span class="mi">577</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">578</span><span class="s2">                 if data:</span>

<span class="nn">~/anaconda3/lib/python3.7/site-packages/urllib3/response.py</span> in <span class="ni">read</span><span class="nt">(self, amt, decode_content, cache_content)</span>
<span class="g g-Whitespace">    </span><span class="mi">517</span><span class="s2">             else:</span>
<span class="g g-Whitespace">    </span><span class="mi">518</span><span class="s2">                 cache_content = False</span>
<span class="ne">--&gt; </span><span class="mi">519</span><span class="s2">                 data = self._fp.read(amt) if not fp_closed else b&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">520</span><span class="s2">                 if (</span>
<span class="g g-Whitespace">    </span><span class="mi">521</span><span class="s2">                     amt != 0 and not data</span>

<span class="nn">~/anaconda3/lib/python3.7/http/client.py</span> in <span class="ni">read</span><span class="nt">(self, amt)</span>
<span class="g g-Whitespace">    </span><span class="mi">445</span><span class="s2">             # Amount is given, implement using readinto</span>
<span class="g g-Whitespace">    </span><span class="mi">446</span><span class="s2">             b = bytearray(amt)</span>
<span class="ne">--&gt; </span><span class="mi">447</span><span class="s2">             n = self.readinto(b)</span>
<span class="g g-Whitespace">    </span><span class="mi">448</span><span class="s2">             return memoryview(b)[:n].tobytes()</span>
<span class="g g-Whitespace">    </span><span class="mi">449</span><span class="s2">         else:</span>

<span class="nn">~/anaconda3/lib/python3.7/http/client.py</span> in <span class="ni">readinto</span><span class="nt">(self, b)</span>
<span class="g g-Whitespace">    </span><span class="mi">489</span><span class="s2">         # connection, and the user is reading more bytes than will be provided</span>
<span class="g g-Whitespace">    </span><span class="mi">490</span><span class="s2">         # (for example, reading in 1k chunks)</span>
<span class="ne">--&gt; </span><span class="mi">491</span><span class="s2">         n = self.fp.readinto(b)</span>
<span class="g g-Whitespace">    </span><span class="mi">492</span><span class="s2">         if not n and b:</span>
<span class="g g-Whitespace">    </span><span class="mi">493</span><span class="s2">             # Ideally, we would raise IncompleteRead if the content-length</span>

<span class="nn">~/anaconda3/lib/python3.7/socket.py</span> in <span class="ni">readinto</span><span class="nt">(self, b)</span>
<span class="g g-Whitespace">    </span><span class="mi">587</span><span class="s2">         while True:</span>
<span class="g g-Whitespace">    </span><span class="mi">588</span><span class="s2">             try:</span>
<span class="ne">--&gt; </span><span class="mi">589</span><span class="s2">                 return self._sock.recv_into(b)</span>
<span class="g g-Whitespace">    </span><span class="mi">590</span><span class="s2">             except timeout:</span>
<span class="g g-Whitespace">    </span><span class="mi">591</span><span class="s2">                 self._timeout_occurred = True</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="section" id="spike-times">
<h2><span class="section-number">3.3.1. </span>Spike Times<a class="headerlink" href="#spike-times" title="Permalink to this headline">¶</a></h2>
<p>Our <code class="docutils literal notranslate"><span class="pre">EcephysSession</span></code> object contains spike times for each unit and they can be accessed via the <code class="docutils literal notranslate"><span class="pre">spike_times</span></code> attribute. This returns a dictionary where the <code class="docutils literal notranslate"><span class="pre">unit_id</span></code> of the neural units are mapped to a list of spike times.  With this data, we are able to compare <code class="docutils literal notranslate"><span class="pre">spike_times</span></code> across units and across stimuli by plotting rasterplots and peristimulus time histograms (PSTHs).</p>
<p>Because there are many units in a given session, we first need to select a subgroup of units to focus on. For the purposes of this notebook we will work with units that were taken from the primary visual area (<code class="docutils literal notranslate"><span class="pre">VISp</span></code>). Below, we will assign spike times of units from the <code class="docutils literal notranslate"><span class="pre">VISp</span></code> area.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assign the spike times in this particular session session</span>
<span class="n">all_spike_times</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">spike_times</span>

<span class="c1"># Assign a list of unit ids for units in VISp brain area</span>
<span class="n">VISp_unit_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">good_units_df</span><span class="p">[</span><span class="n">good_units_df</span><span class="p">[</span><span class="s1">&#39;ecephys_structure_acronym&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VISp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># Assign spike times of first 4 VISp unit entries </span>
<span class="n">VISp_spike_times</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">VISp_spike_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_spike_times</span><span class="p">[</span><span class="n">VISp_unit_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spikes found for unit </span><span class="si">{</span><span class="n">VISp_unit_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_spike_times</span><span class="p">[</span><span class="n">VISp_unit_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">all_spike_times</span><span class="p">[</span><span class="n">VISp_unit_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Spikes found for unit 950934565 : 20255
[  12.54503374   12.59396707   12.66863375 ... 9662.03616445 9662.14643112
 9662.32143114]
Spikes found for unit 950934614 : 40170
[9.35699445e-01 4.06189970e+00 4.29429972e+00 ... 9.66156133e+03
 9.66302430e+03 9.66332806e+03]
Spikes found for unit 950934597 : 60719
[6.37236656e+00 6.51769991e+00 7.45033332e+00 ... 9.66515473e+03
 9.66529646e+03 9.66552750e+03]
Spikes found for unit 950934762 : 309793
[9.52799446e-01 1.17843280e+00 1.78076618e+00 ... 9.66512993e+03
 9.66522573e+03 9.66547786e+03]
</pre></div>
</div>
</div>
</div>
<p>With these spike times, we can create a raster plot for our unit of interst. Below we will plot  the first 50 seconds of the session.</p>
<p><font color="red">In a previous chapter, we used plt.eventplot(). Should we be consistent?</font></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

<span class="c1"># Plot a raster plot for units of interest</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">VISp_spike_times</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">VISp_spike_times</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">VISp_unit_ids</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Units&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_6_0.png" src="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_6_0.png" />
</div>
</div>
<p>A raster plot maybe difficult to see the overall firing activity of a unit becasue there are too many spikes. Instead of looking at each individual spike across time, we can bin our spikes into 1 second bins and plot the spike frequency of each bin using the same function similar to the one we encountered in <a class="reference external" href="https://neuraldatascience.github.io/Chapter_02/Sample_Visualizations.html">Chapter 2.3</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_firing_rates</span><span class="p">(</span><span class="n">spike_times</span><span class="p">,</span> <span class="n">start_time</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">,</span> <span class="n">end_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="c1"># Create Subplot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spike_times</span><span class="p">),</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
    
    <span class="c1"># Create PSTH on each sublot</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spike_times</span><span class="p">)):</span>

        <span class="c1"># Assign total number of bins </span>
        <span class="n">numbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">spike_times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
        <span class="n">binned_spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">numbins</span><span class="p">))</span>

        <span class="c1"># Assign the frequency of spikes over time</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numbins</span><span class="p">):</span>
            <span class="n">binned_spikes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_times</span><span class="p">[</span><span class="n">i</span><span class="p">][(</span><span class="n">spike_times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">j</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">spike_times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">binned_spikes</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Firing (Hz)&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">start_time</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
    
    <span class="k">return</span> 

<span class="n">plot_firing_rates</span><span class="p">(</span><span class="n">VISp_spike_times</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_8_0.png" src="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_8_0.png" />
</div>
</div>
</div>
<div class="section" id="stimulus-presentations">
<h2><span class="section-number">3.3.2. </span>Stimulus Presentations<a class="headerlink" href="#stimulus-presentations" title="Permalink to this headline">¶</a></h2>
<p>The spike data can be sorted according to the type of stimulus that was presented to the mouse. You can access the different stimuli that were presented in the session by using the attribute <code class="docutils literal notranslate"><span class="pre">stimulus_names</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Stimuli presented in session</span>
<span class="n">all_stims</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">stimulus_names</span>
<span class="n">all_stims</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;spontaneous&#39;,
 &#39;gabors&#39;,
 &#39;invalid_presentation&#39;,
 &#39;flashes&#39;,
 &#39;drifting_gratings&#39;,
 &#39;natural_movie_three&#39;,
 &#39;natural_movie_one&#39;,
 &#39;static_gratings&#39;,
 &#39;natural_scenes&#39;]
</pre></div>
</div>
</div>
</div>
<p>Each stimulus contains a set of parameters that were used when presented to the mouse. For example two gabors stimuli may be presented, but they may have differing temporal frequencies or different x and y positions. Executing the <code class="docutils literal notranslate"><span class="pre">stimulus_presentations</span></code> method on our session object will return a pandas dataframe with parameters for each stimulus as the columns which we can use to compare the resoponses of units to different stimulus presentations.</p>
<p><strong>Note</strong>: Not all stimuli share the same parameters. If certain parameters do not apply to a stimulus, you will see a <code class="docutils literal notranslate"><span class="pre">null</span></code> value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Stimulus presentation dataframe </span>
<span class="n">stim_pres</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">stimulus_presentations</span>
<span class="n">stim_pres</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>color</th>
      <th>contrast</th>
      <th>frame</th>
      <th>orientation</th>
      <th>phase</th>
      <th>size</th>
      <th>spatial_frequency</th>
      <th>start_time</th>
      <th>stimulus_block</th>
      <th>stimulus_name</th>
      <th>stop_time</th>
      <th>temporal_frequency</th>
      <th>x_position</th>
      <th>y_position</th>
      <th>duration</th>
      <th>stimulus_condition_id</th>
    </tr>
    <tr>
      <th>stimulus_presentation_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>null</td>
      <td>null</td>
      <td>null</td>
      <td>null</td>
      <td>null</td>
      <td>null</td>
      <td>null</td>
      <td>29.830107</td>
      <td>null</td>
      <td>spontaneous</td>
      <td>89.896827</td>
      <td>null</td>
      <td>null</td>
      <td>null</td>
      <td>60.066720</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>null</td>
      <td>0.8</td>
      <td>null</td>
      <td>0</td>
      <td>[3644.93333333, 3644.93333333]</td>
      <td>[20.0, 20.0]</td>
      <td>0.08</td>
      <td>89.896827</td>
      <td>0</td>
      <td>gabors</td>
      <td>90.130356</td>
      <td>4</td>
      <td>10</td>
      <td>-10</td>
      <td>0.233528</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>null</td>
      <td>0.8</td>
      <td>null</td>
      <td>90</td>
      <td>[3644.93333333, 3644.93333333]</td>
      <td>[20.0, 20.0]</td>
      <td>0.08</td>
      <td>90.130356</td>
      <td>0</td>
      <td>gabors</td>
      <td>90.380565</td>
      <td>4</td>
      <td>-30</td>
      <td>20</td>
      <td>0.250209</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>null</td>
      <td>0.8</td>
      <td>null</td>
      <td>0</td>
      <td>[3644.93333333, 3644.93333333]</td>
      <td>[20.0, 20.0]</td>
      <td>0.08</td>
      <td>90.380565</td>
      <td>0</td>
      <td>gabors</td>
      <td>90.630774</td>
      <td>4</td>
      <td>20</td>
      <td>-20</td>
      <td>0.250209</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>null</td>
      <td>0.8</td>
      <td>null</td>
      <td>90</td>
      <td>[3644.93333333, 3644.93333333]</td>
      <td>[20.0, 20.0]</td>
      <td>0.08</td>
      <td>90.630774</td>
      <td>0</td>
      <td>gabors</td>
      <td>90.880983</td>
      <td>4</td>
      <td>30</td>
      <td>20</td>
      <td>0.250209</td>
      <td>4.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Each stimulus used in the session is presented to the mouse in various timeblocks. Using the <code class="docutils literal notranslate"><span class="pre">get_stimulus_epochs()</span></code> method will return a pandas dataframe containing the time periods where a single stimulus type was presented continuously.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Continous timeblocks where only 1 type of stimulus was presented</span>
<span class="n">stim_timeblocks</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_stimulus_epochs</span><span class="p">()</span>
<span class="n">stim_timeblocks</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start_time</th>
      <th>stop_time</th>
      <th>duration</th>
      <th>stimulus_name</th>
      <th>stimulus_block</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>29.830107</td>
      <td>89.896827</td>
      <td>60.066720</td>
      <td>spontaneous</td>
      <td>null</td>
    </tr>
    <tr>
      <th>1</th>
      <td>89.896827</td>
      <td>969.865012</td>
      <td>879.968184</td>
      <td>gabors</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>969.865012</td>
      <td>982.125255</td>
      <td>12.260244</td>
      <td>invalid_presentation</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>982.125255</td>
      <td>1001.891772</td>
      <td>19.766516</td>
      <td>gabors</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1001.891772</td>
      <td>1290.883097</td>
      <td>288.991326</td>
      <td>spontaneous</td>
      <td>null</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The timeblocks above allow us to compare neural activity when a new stimulus is being presented. By using <code class="docutils literal notranslate"><span class="pre">plt.axvspan</span></code> we can divide our current plot to show when one stimulus ends and a new one begins. Plotting this over the firing rates of our units will reveal what <code class="docutils literal notranslate"><span class="pre">stimulus_name</span></code> elicited the highest neural activity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot first 10 VISp entries spike times in 1 second bins</span>
<span class="n">numunits</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">numbins</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">VISp_spike_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
<span class="n">visp_binned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">numunits</span><span class="p">,</span> <span class="n">numbins</span><span class="p">))</span>

<span class="c1"># Bin each unit&#39;s spike times into 1 second bins</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numunits</span><span class="p">):</span>
    <span class="n">unit_id</span> <span class="o">=</span> <span class="n">VISp_unit_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">spikes</span> <span class="o">=</span> <span class="n">all_spike_times</span><span class="p">[</span><span class="n">unit_id</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numbins</span><span class="p">):</span>
        <span class="n">visp_binned</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes</span><span class="p">[(</span><span class="n">spikes</span><span class="o">&gt;</span><span class="n">j</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">spikes</span><span class="o">&lt;</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
        
<span class="c1"># Plots firing rates, offset each spike train by i</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numunits</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">visp_binned</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span><span class="mf">30.</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="c1"># Plots rectangle blocks that indicate new stimulus presentation </span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;pink&#39;</span><span class="p">,</span> <span class="s1">&#39;violet&#39;</span><span class="p">,</span><span class="s1">&#39;gray&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">stim_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_stims</span><span class="p">):</span>
    <span class="n">stim</span> <span class="o">=</span> <span class="n">stim_timeblocks</span><span class="p">[</span><span class="n">stim_timeblocks</span><span class="p">[</span><span class="s1">&#39;stimulus_name&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">stim_name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stim</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="n">stim</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> 
                    <span class="n">xmax</span><span class="o">=</span><span class="n">stim</span><span class="p">[</span><span class="s1">&#39;stop_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">c</span><span class="p">],</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
        
<span class="c1"># Legend showing stimulus timeblocks</span>
<span class="n">colors_leg</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)):</span>
    <span class="n">temp_color</span> <span class="o">=</span> <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_stims</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">colors_leg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_color</span><span class="p">)</span>  

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span> <span class="o">=</span> <span class="n">colors_leg</span><span class="p">,</span> <span class="n">bbox_to_anchor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">VISp_unit_ids</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Units&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">750</span><span class="p">,</span><span class="mi">2500</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_18_0.png" src="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_18_0.png" />
</div>
</div>
<p>Alternatively, you could use the <code class="docutils literal notranslate"><span class="pre">get_stimulus_table()</span></code> method to return a subset of stimulus presentation by <code class="docutils literal notranslate"><span class="pre">stimulus_name</span></code>. The returned dataframe will only contain parameters that relate to the given <code class="docutils literal notranslate"><span class="pre">stimulus_name</span></code>. Below we will investigate how our neuronal units responded to a <code class="docutils literal notranslate"><span class="pre">natural_scenes</span></code> stimulus presentations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">natural_scenes_df</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get_stimulus_table</span><span class="p">([</span><span class="s1">&#39;natural_scenes&#39;</span><span class="p">])</span>
<span class="n">natural_scenes_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>frame</th>
      <th>start_time</th>
      <th>stimulus_block</th>
      <th>stimulus_name</th>
      <th>stop_time</th>
      <th>duration</th>
      <th>stimulus_condition_id</th>
    </tr>
    <tr>
      <th>stimulus_presentation_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>51353</th>
      <td>34</td>
      <td>5908.739537</td>
      <td>9</td>
      <td>natural_scenes</td>
      <td>5908.989739</td>
      <td>0.250201</td>
      <td>4908.0</td>
    </tr>
    <tr>
      <th>51354</th>
      <td>6</td>
      <td>5908.989739</td>
      <td>9</td>
      <td>natural_scenes</td>
      <td>5909.239940</td>
      <td>0.250201</td>
      <td>4909.0</td>
    </tr>
    <tr>
      <th>51355</th>
      <td>28</td>
      <td>5909.239940</td>
      <td>9</td>
      <td>natural_scenes</td>
      <td>5909.490142</td>
      <td>0.250201</td>
      <td>4910.0</td>
    </tr>
    <tr>
      <th>51356</th>
      <td>109</td>
      <td>5909.490142</td>
      <td>9</td>
      <td>natural_scenes</td>
      <td>5909.740343</td>
      <td>0.250201</td>
      <td>4911.0</td>
    </tr>
    <tr>
      <th>51357</th>
      <td>105</td>
      <td>5909.740343</td>
      <td>9</td>
      <td>natural_scenes</td>
      <td>5909.990554</td>
      <td>0.250211</td>
      <td>4912.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can look even further and check how the parameters of a stimulus affected the firing rate. In <code class="docutils literal notranslate"><span class="pre">natural_scenes</span></code> presentations, different frames/images were presented to the mouse. Below we will focus on the times that the first <code class="docutils literal notranslate"><span class="pre">frame</span></code> in <code class="docutils literal notranslate"><span class="pre">natural_scenes_df</span></code>, was presented in the session.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assign indices for presentations of our frame of interest</span>
<span class="n">natural_scenes_ids</span> <span class="o">=</span> <span class="n">natural_scenes_df</span><span class="o">.</span><span class="n">index</span>

<span class="c1"># Assign &#39;natural_scenes&#39; image id of interest</span>
<span class="n">my_image</span> <span class="o">=</span> <span class="n">natural_scenes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">natural_scenes_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;frame&#39;</span><span class="p">]</span>

<span class="c1"># Return the number of times this image was presented</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of times frame &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">my_image</span><span class="p">)</span><span class="o">+</span> <span class="s1">&#39; was presented in the session:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">natural_scenes_df</span><span class="p">[</span><span class="n">natural_scenes_df</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">my_image</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of times frame 6.0 was presented in the session:
50
</pre></div>
</div>
</div>
</div>
<p>As you can see from the dataframe above, we also have start and end times for a given stimulus presentation available to us. We can do what we did before and use <code class="docutils literal notranslate"><span class="pre">plt.axvspan()</span></code> to plot the times when the images of interest was presented over the firing rates of our session.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Assign a dataframe that only contains presentations of our image of interest</span>
<span class="n">stim_subset</span> <span class="o">=</span> <span class="n">natural_scenes_df</span><span class="p">[</span><span class="n">natural_scenes_df</span><span class="p">[</span><span class="s1">&#39;frame&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">my_image</span><span class="p">]</span>

<span class="c1"># Offset the firing rates and plot them</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numunits</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="p">(</span><span class="n">visp_binned</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span><span class="mi">50</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># Plot the times are image of interest was presented</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_subset</span><span class="p">)):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">xmin</span><span class="o">=</span><span class="n">stim_subset</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">xmax</span><span class="o">=</span><span class="n">stim_subset</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Presentation of Image Frame &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">my_image</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Units&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">6700</span><span class="p">,</span><span class="mi">7200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_24_0.png" src="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_24_0.png" />
</div>
</div>
<p>You are not limited to only plotting the times where a certain image was presented, nor are you limited to only plotting <code class="docutils literal notranslate"><span class="pre">natural_scenes</span></code> stimuli. You can create a similar graph with <code class="docutils literal notranslate"><span class="pre">gabors</span></code>, <code class="docutils literal notranslate"><span class="pre">flashes</span></code>, or any other availabe <code class="docutils literal notranslate"><span class="pre">stimulus_name</span></code>. For example, you can plot all the times when a <code class="docutils literal notranslate"><span class="pre">gabors</span></code> stimulus was presented at a certain spatial frequncy, temporal frequency, or orientaion. You can use <code class="docutils literal notranslate"><span class="pre">get_stimulus_parameter_values</span></code> to return a dictionary of all parameters used in a session.</p>
</div>
<div class="section" id="using-the-spykes-module-to-plot-electrophysiology-data">
<h2><span class="section-number">3.3.3. </span>Using the Spykes module to plot electrophysiology data<a class="headerlink" href="#using-the-spykes-module-to-plot-electrophysiology-data" title="Permalink to this headline">¶</a></h2>
<p>Peristimulus time histograms and raster plots can also be created with classes and methods from a package called <code class="docutils literal notranslate"><span class="pre">spykes</span></code>, which contains useful tools for plotting electrophysiology data. If you do not have <code class="docutils literal notranslate"><span class="pre">spykes</span></code> installed, run the cell below. Otherwise, you can skip to the next cell.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip install spykes
</pre></div>
</div>
</div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">spykes</span></code>, we can plot the firing activity of single neurons or of neuron populations. The <code class="docutils literal notranslate"><span class="pre">NeuroVis()</span></code> class is used to visualize single neuron activity. It takes in an array of spike times as an argument as well as the <code class="docutils literal notranslate"><span class="pre">name</span></code> of the neuron. We can then use the fucntion <code class="docutils literal notranslate"><span class="pre">get_raster()</span></code> to compute and plot a raster plot across all stimulus presentations.</p>
<p>Please visit the<a href = 'http://kordinglab.com/spykes/api/plot.html'> spykes plotting section</a> of the spykes documentation for additional help on the classes and functions used below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nvs</span> <span class="o">=</span> <span class="n">NeuroVis</span><span class="p">(</span><span class="n">VISp_spike_times</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;950908410&#39;</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">nvs</span><span class="o">.</span><span class="n">get_raster</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">stim_pres</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_29_0.png" src="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_29_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nvs</span><span class="o">.</span><span class="n">get_psth</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">stim_pres</span><span class="p">,</span> <span class="n">binsize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_30_0.png" src="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_30_0.png" />
</div>
</div>
</div>
<div class="section" id="running-speed">
<h2><span class="section-number">3.3.4. </span>Running Speed<a class="headerlink" href="#running-speed" title="Permalink to this headline">¶</a></h2>
<p>The Allen Institute researchers also collected data on the running speed of their mice. You can access the running speed by calling <code class="docutils literal notranslate"><span class="pre">running_speed</span></code> on our <code class="docutils literal notranslate"><span class="pre">EcephysSession</span></code> object. This will return a dataframe that contains the <code class="docutils literal notranslate"><span class="pre">start_time</span></code>, <code class="docutils literal notranslate"><span class="pre">end_time</span></code>, and <code class="docutils literal notranslate"><span class="pre">velocity</span></code> of our session.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">running_speed</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">running_speed</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">running_speed</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">],</span> <span class="n">running_speed</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Running Speed: Session 721123822&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Velocity (cm/s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_33_0.png" src="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_33_0.png" />
</div>
</div>
<p>With the running speed, we can ask if there is a correlation between the firing rates of our units and the velocity of our mouse. Similar to how we plotted above, we can plot the running speed of the session over the firing rates and see if increases in running speed align with increases in neural activity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span>

<span class="c1"># Plot firing rates</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numunits</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">i</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">visp_binned</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">/</span><span class="mi">10</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Units&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">2400</span><span class="p">,</span><span class="mi">2700</span><span class="p">)</span>

<span class="c1"># Plot the running speed underneath     </span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">running_speed</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">running_speed</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Velocity (cm/s)&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">2400</span><span class="p">,</span><span class="mi">2700</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_35_0.png" src="../_images/Aligning_Spike_Trains_with_Stimuli_and_Behavior_35_0.png" />
</div>
</div>
<p>Even by eye, you can see that the firing rate of the fourth neuron we plotted (and maybe a couple others) seem to be correlated with the mouse’s running speed.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Chapter_03"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="Obtaining_Raw_Electrophysiology_Data.html" title="previous page"><span class="section-number">3.2. </span>Obtaining Raw Electrophysiology Data from the AllenSDK</a>
    <a class='right-next' id="next-link" href="Identifying_Cells_with_Optogenetics.html" title="next page"><span class="section-number">3.4. </span>Identifying Cells with Optogenetics</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Victor Magdaleno-Garcia & Ashley Juavinett<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>