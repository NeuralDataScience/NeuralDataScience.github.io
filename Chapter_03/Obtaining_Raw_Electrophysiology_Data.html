
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3.2. Obtaining Electrophysiology Data from the AllenSDK &#8212; Teaching &amp; Learning with NWB Datasets</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.acff12b8f9c144ce68a297486a2fa670.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="3.3. Aligning Spike Trains with Visual Stimuli and Behavior" href="Aligning_Spike_Trains_with_Stimuli_and_Behavior.html" />
    <link rel="prev" title="3.1. Visualizing Large Scale Recordings" href="Visualizing_Large_Scale_Recordings.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      <img src="../_static/nwb_learning.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Teaching & Learning with NWB Datasets</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../landing_page.html">
   Teaching and Learning with NWB Datasets
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_01/Data_Science_In_Python.html">
   1. Data Science in Python
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_01/NumPy.html">
     1.3. NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_01/Pandas.html">
     1.4. Pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_01/SciPy.html">
     1.5. SciPy
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_02/Obtaining_and_Working_with_NWB_Datasets.html">
   2. Obtaining and Working with NWB Datasets
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_02/Obtaining_Datasets_with_DANDI.html">
     2.1. Obtaining Datasets with DANDI
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_02/Working_with_NWB_format_in_Python.html">
     2.2. Working with NWB in Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_02/Chapter_2_ProblemSet.html">
     2.3. Chapter 2 Problem Set
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="Large_Scale_Electrophysiology.html">
   3. Large Scale Electrophysiology
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="Visualizing_Large_Scale_Recordings.html">
     3.1. Visualizing Large Scale Recordings
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     3.2. Obtaining  Electrophysiology Data from the AllenSDK
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Aligning_Spike_Trains_with_Stimuli_and_Behavior.html">
     3.3. Aligning Spike Trains with Visual Stimuli and Behavior
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Identifying_Cells_with_Optogenetics.html">
     3.4. Identifying Cells with Optogenetics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Chapter_3_ProblemSet.html">
     3.5. Chapter 3 Problem Set
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_04/Single-Cell_Electrophysiology.html">
   4. Single-Cell Electrophysiology
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_04/Obtaining_Data_For_Single_Cells.html">
     4.1. Obtaining Data for Single Cells
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_04/Analyzing_Computed_Features.html">
     4.2. Analyzing Computed Features
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../Chapter_05/Two_Photon_Imaging.html">
   5. Two Photon Imaging
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_05/Excitatory_Inhibitory_Decisions.html">
     5.1. Decision Making in Excitatory &amp; Inhibitory Cells
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_05/Retrieving_Brain_Observatory_Data.html">
     5.2. Retrieving Calcium Imaging Data from the AllenSDK
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_05/Analyzing_Two_Photon_Data.html">
     5.3. Analyzing Two Photon Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../Chapter_05/Correlations_in_Two_Photon_Data.html">
     5.4. Correlations in Two Photon Data
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/Chapter_03/Obtaining_Raw_Electrophysiology_Data.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/NeuralDataScience/NeuralDataScience.github.io/master?urlpath=tree/Chapter_03/Obtaining_Raw_Electrophysiology_Data.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/NeuralDataScience/NeuralDataScience.github.io/blob/master/Chapter_03/Obtaining_Raw_Electrophysiology_Data.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#downloading-a-single-session-the-structure-of-session-files">
   3.2.1. Downloading a Single Session &amp; the Structure of Session Files
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#obtaining-single-units">
   3.2.2. Obtaining Single Units
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#obtaining-single-action-potential-waveforms">
   3.2.3. Obtaining Single Action Potential Waveforms
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#additional-resources">
     3.2.3.1. Additional Resources
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="obtaining-electrophysiology-data-from-the-allensdk">
<h1><span class="section-number">3.2. </span>Obtaining  Electrophysiology Data from the AllenSDK<a class="headerlink" href="#obtaining-electrophysiology-data-from-the-allensdk" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference external" href="https://portal.brain-map.org/explore/circuits/visual-coding-neuropixels">Visual Coding - Neuropixels dataset from the Allen Institute of Brain Sciences</a> records spiking activity in the visual system of the mouse brain. At the time of writing, this dataset contains a total of 58 experiment sessions from Neuropixels probes in the cortex, hippocampus, and thalamus. There are three different trangenic mouse lines used in the experiments alongside the wild-type mice, which mark three different inhibitory cell types. The stimuli presented in this dataset range from natural scenes to drifting gratings.</p>
<p>In this chapter you will learn how to download and sort through the Neuropixels dataset. Once you learn the basics, you will learn how to perform possible analyses to explain the neural activity within, as well as how to use optogenetics to identify different cell types within the data.</p>
<p>This section will teach you how to interact with the Allen Institute Neuropixels dataset, specifically how to download experimental sessions, return processed data, and subset your data to contain only brain regions you are interested in.</p>
<p>First things first, let’s make sure you have the AllenSDK installed. See the <a class="reference external" href="https://alleninstitute.github.io/AllenSDK/install.html">Allen Institute website</a> for information on installing it, otherwise, the cell below will do it for you.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This will ensure that the AllenSDK is installed.</span>
<span class="c1"># If not, it will install it for you.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">allensdk</span>
    <span class="k">if</span> <span class="n">allensdk</span><span class="o">.</span><span class="n">__version__</span> <span class="o">==</span> <span class="s1">&#39;2.11.2&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;allensdk already installed.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;incompatible version of allensdk installed&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="o">!</span>pip install allensdk
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>allensdk already installed.
</pre></div>
</div>
</div>
</div>
<p>We will first need to import the <code class="docutils literal notranslate"><span class="pre">EcephysProjectCache</span></code> from the Allen SDK and create an instance of the class. The class is used to download the metadata and data for all sessions in the Neuropixels dataset. For the full list of methods, please visit the <code class="docutils literal notranslate"><span class="pre">allensdk.brain_observatory.ecephys.ecephys_project_cache</span></code> module documentation on the <a href = 'https://allensdk.readthedocs.io/en/v1.7.1/allensdk.brain_observatory.ecephys.ecephys_project_cache.html'>Allen SDK website</a>. We’ll create an instance of <code class="docutils literal notranslate"><span class="pre">EcephysProjectCache</span></code> with a larger <code class="docutils literal notranslate"><span class="pre">timeout</span></code> value to ensure enough time is allowed for our session file to download below.</p>
<p>Below we will execute <code class="docutils literal notranslate"><span class="pre">get_session_table()</span></code> on our <code class="docutils literal notranslate"><span class="pre">EcephysProjectCache</span></code> object which will return a dataframe with metadata on each session.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Import packages necessary to plot behavior</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline 
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Import allensdkd brain observatory packages</span>
<span class="kn">from</span> <span class="nn">allensdk.brain_observatory.ecephys.ecephys_project_cache</span> <span class="kn">import</span> <span class="n">EcephysProjectCache</span>
<span class="kn">from</span> <span class="nn">allensdk.brain_observatory.ecephys.ecephys_project_api</span> <span class="kn">import</span> <span class="n">EcephysProjectWarehouseApi</span>
<span class="kn">from</span> <span class="nn">allensdk.brain_observatory.ecephys.ecephys_project_api.rma_engine</span> <span class="kn">import</span> <span class="n">RmaEngine</span>
<span class="kn">import</span> <span class="nn">allensdk.brain_observatory.ecephys.visualization</span> <span class="k">as</span> <span class="nn">ecvis</span>

<span class="c1"># Assign where data will be stored</span>
<span class="n">manifest_path</span> <span class="o">=</span> <span class="s1">&#39;manifest.json&#39;</span> 

<span class="c1"># Create the EcephysProjectCache object</span>
<span class="n">cache</span> <span class="o">=</span> <span class="n">EcephysProjectCache</span><span class="p">(</span><span class="n">manifest</span><span class="o">=</span><span class="n">manifest_path</span><span class="p">,</span>
                            <span class="n">fetch_api</span><span class="o">=</span><span class="n">EcephysProjectWarehouseApi</span><span class="p">(</span><span class="n">RmaEngine</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;http&quot;</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;api.brain-map.org&quot;</span><span class="p">,</span><span class="n">timeout</span><span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)))</span>    

<span class="c1"># Return all sessions available in this dataset</span>
<span class="n">sessions</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_session_table</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total number of sessions: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sessions</span><span class="p">)))</span>
<span class="n">sessions</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total number of sessions: 58
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>published_at</th>
      <th>specimen_id</th>
      <th>session_type</th>
      <th>age_in_days</th>
      <th>sex</th>
      <th>full_genotype</th>
      <th>unit_count</th>
      <th>channel_count</th>
      <th>probe_count</th>
      <th>ecephys_structure_acronyms</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>715093703</th>
      <td>2019-10-03T00:00:00Z</td>
      <td>699733581</td>
      <td>brain_observatory_1.1</td>
      <td>118.0</td>
      <td>M</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>884</td>
      <td>2219</td>
      <td>6</td>
      <td>[CA1, VISrl, nan, PO, LP, LGd, CA3, DG, VISl, ...</td>
    </tr>
    <tr>
      <th>719161530</th>
      <td>2019-10-03T00:00:00Z</td>
      <td>703279284</td>
      <td>brain_observatory_1.1</td>
      <td>122.0</td>
      <td>M</td>
      <td>Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>755</td>
      <td>2214</td>
      <td>6</td>
      <td>[TH, Eth, APN, POL, LP, DG, CA1, VISpm, nan, N...</td>
    </tr>
    <tr>
      <th>721123822</th>
      <td>2019-10-03T00:00:00Z</td>
      <td>707296982</td>
      <td>brain_observatory_1.1</td>
      <td>125.0</td>
      <td>M</td>
      <td>Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt</td>
      <td>444</td>
      <td>2229</td>
      <td>6</td>
      <td>[MB, SCig, PPT, NOT, DG, CA1, VISam, nan, LP, ...</td>
    </tr>
    <tr>
      <th>732592105</th>
      <td>2019-10-03T00:00:00Z</td>
      <td>717038288</td>
      <td>brain_observatory_1.1</td>
      <td>100.0</td>
      <td>M</td>
      <td>wt/wt</td>
      <td>824</td>
      <td>1847</td>
      <td>5</td>
      <td>[grey, VISpm, nan, VISp, VISl, VISal, VISrl]</td>
    </tr>
    <tr>
      <th>737581020</th>
      <td>2019-10-03T00:00:00Z</td>
      <td>718643567</td>
      <td>brain_observatory_1.1</td>
      <td>108.0</td>
      <td>M</td>
      <td>wt/wt</td>
      <td>568</td>
      <td>2218</td>
      <td>6</td>
      <td>[grey, VISmma, nan, VISpm, VISp, VISl, VISrl]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>A few columns that we may want to pay attention to for future analysis are the <code class="docutils literal notranslate"><span class="pre">full_genotype</span></code>, <code class="docutils literal notranslate"><span class="pre">unit_count</span></code>, and <code class="docutils literal notranslate"><span class="pre">ecephys_structure_acronyms</span></code>.</p>
<p>In this dataset, a <code class="docutils literal notranslate"><span class="pre">unit</span></code> referes to an individual neuron that was recorded in the session. The <code class="docutils literal notranslate"><span class="pre">unit_count</span></code> refers to the total number of neurons recorded in a particular sesssion. As mentioned in the chapter introduction, three different genotypes of mice were used alongside the wildtype mice for these experiments. You can find the genotype under <code class="docutils literal notranslate"><span class="pre">full_genotype</span></code>. Lastly, you can find what structures the data in a session was collected from under <code class="docutils literal notranslate"><span class="pre">ecephys_structure_acronyms</span></code>.</p>
<p>Below we will return the following information on our sessions:</p>
<ul class="simple">
<li><p>how many sessions per genotype</p></li>
<li><p>the average number of units recorded per session</p></li>
<li><p>what brain structures were used in our sessions</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">genotypes</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;full_genotype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">avg_units</span> <span class="o">=</span> <span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;unit_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">brain_areas</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">structure</span> <span class="ow">in</span> <span class="n">sessions</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">[</span><span class="s1">&#39;ecephys_structure_acronyms&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">brain_areas</span><span class="p">:</span>
            <span class="n">brain_areas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Genotype Count:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">genotypes</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Average Units:&#39;</span><span class="p">,</span><span class="n">avg_units</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">All brain areas:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">brain_areas</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Genotype Count:
wt/wt                                              30
Sst-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt      12
Vip-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt       8
Pvalb-IRES-Cre/wt;Ai32(RCL-ChR2(H134R)_EYFP)/wt     8
Name: full_genotype, dtype: int64

Average Units: 689.8275862068965

All brain areas:
[&#39;CA1&#39;, &#39;VISrl&#39;, nan, &#39;PO&#39;, &#39;LP&#39;, &#39;LGd&#39;, &#39;CA3&#39;, &#39;DG&#39;, &#39;VISl&#39;, &#39;PoT&#39;, &#39;VISp&#39;, &#39;grey&#39;, &#39;VISpm&#39;, &#39;APN&#39;, &#39;MB&#39;, &#39;VISam&#39;, &#39;TH&#39;, &#39;Eth&#39;, &#39;POL&#39;, &#39;NOT&#39;, &#39;SUB&#39;, &#39;VL&#39;, &#39;CA2&#39;, &#39;VPM&#39;, &#39;VISal&#39;, &#39;SCig&#39;, &#39;PPT&#39;, &#39;VIS&#39;, &#39;ProS&#39;, &#39;LGv&#39;, &#39;HPF&#39;, &#39;VISmma&#39;, &#39;PP&#39;, &#39;PIL&#39;, &#39;MGv&#39;, &#39;VPL&#39;, &#39;IGL&#39;, &#39;SGN&#39;, &#39;IntG&#39;, &#39;LD&#39;, &#39;MGm&#39;, &#39;MGd&#39;, &#39;POST&#39;, &#39;MRN&#39;, &#39;VISli&#39;, &#39;OP&#39;, &#39;ZI&#39;, &#39;VISmmp&#39;, &#39;PF&#39;, &#39;LT&#39;, &#39;RPF&#39;, &#39;PRE&#39;, &#39;SCiw&#39;, &#39;CP&#39;, &#39;COAa&#39;, &#39;RT&#39;, &#39;SCop&#39;, &#39;SCsg&#39;, &#39;SCzo&#39;, &#39;COApm&#39;, &#39;OLF&#39;, &#39;BMAa&#39;]
</pre></div>
</div>
</div>
</div>
<p>Let’s say we only want sessions where the data has recordings from primary visual cortex (VISp). We can do the following to create a session list that we want.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">session_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">structure_list</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sessions</span><span class="p">[</span><span class="s1">&#39;ecephys_structure_acronyms&#39;</span><span class="p">]):</span>
    <span class="k">if</span> <span class="s1">&#39;VISp&#39;</span> <span class="ow">in</span> <span class="n">structure_list</span><span class="p">:</span>
        <span class="n">session_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sessions</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>   
        
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">session_list</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; sessions that meet this criteria:&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">session_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>There are 56 sessions that meet this criteria:
[715093703, 719161530, 721123822, 732592105, 737581020, 739448407, 742951821, 743475441, 744228101, 746083955, 750332458, 750749662, 751348571, 754312389, 754829445, 755434585, 756029989, 757216464, 757970808, 758798717, 759883607, 760345702, 760693773, 761418226, 762120172, 762602078, 763673393, 766640955, 767871931, 768515987, 771160300, 771990200, 773418906, 774875821, 778240327, 778998620, 779839471, 781842082, 786091066, 787025148, 789848216, 791319847, 793224716, 794812542, 797828357, 798911424, 799864342, 816200189, 821695405, 829720705, 831882777, 835479236, 839068429, 839557629, 840012044, 847657808]
</pre></div>
</div>
</div>
</div>
<div class="section" id="downloading-a-single-session-the-structure-of-session-files">
<h2><span class="section-number">3.2.1. </span>Downloading a Single Session &amp; the Structure of Session Files<a class="headerlink" href="#downloading-a-single-session-the-structure-of-session-files" title="Permalink to this headline">¶</a></h2>
<p>Now, we can use the session list to get the data we need. Unfortunately, we can only extract one experiment at a time, so if you want to do this for multiple experiments, you’ll need to loop over the <code class="docutils literal notranslate"><span class="pre">get_session_data</span></code> method for your entire session_list. For example, your workflow might be:</p>
<ol class="simple">
<li><p>Extract one session.</p></li>
<li><p>Look for units recorded from your brain region of interest in that session.</p></li>
<li><p>Extract whatever metric you’re interested in (e.g., firing rate).</p></li>
<li><p>Append those values to a list of firing rates.</p></li>
<li><p>Loop back around to the next session.</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">get_session_data</span></code> downloads the <code class="docutils literal notranslate"><span class="pre">NWB</span></code> data file of our experiment session and returns a session object that contains data and metadata for a single session. For a full list of methods and attributes for an ecephys session object, please visit the <a href = 'https://allensdk.readthedocs.io/en/v1.7.1/allensdk.brain_observatory.ecephys.ecephys_session.html'> Allen SDK session module documentation</a>. Here, we’ll just take one session as an example.</p>
<p><strong>Note</strong>: The session files are very large files that will take some time to download depending on your connection speed. It is important that you do not stop the download as the cell is running because this will truncate the file and you will not be able to work with the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Download our single session data </span>
<span class="n">session</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_session_data</span><span class="p">(</span><span class="n">session_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Session downloaded.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Session downloaded.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="obtaining-single-units">
<h2><span class="section-number">3.2.2. </span>Obtaining Single Units<a class="headerlink" href="#obtaining-single-units" title="Permalink to this headline">¶</a></h2>
<p>Now that we have downloaded the single session file, we can begin to explore our <code class="docutils literal notranslate"><span class="pre">EcephysSession</span></code> object. The <code class="docutils literal notranslate"><span class="pre">units</span></code> property of our session object returns a dataframe that contains the recorded activity of sorted neurons from a mouse brain. There are many metrics stored within <code class="docutils literal notranslate"><span class="pre">units</span></code> that can be used in your potential analyses. Some key metrics include:</p>
<ul class="simple">
<li><p><strong>firing rate</strong>: mean spike rate during the entire session</p></li>
<li><p><strong>presence ratio</strong>: fraction of session when spikes are present</p></li>
<li><p><strong>ISI violations</strong>: rate of refractory period violations</p></li>
<li><p><strong>peak_channel_id</strong>: channel in which peak-to-trough amplitutde is maximized</p></li>
<li><p><strong>d’</strong>: classification accuracy based on LDA</p></li>
<li><p><strong>SNR</strong>: signal to noise ratio</p></li>
<li><p><strong>Maximum drift</strong>: Maximum change in spike depth during recording</p></li>
<li><p><strong>Cumulative drift</strong>: Cumulative change in spike depth during recording</p></li>
</ul>
<p>For a full list of methods and attributes that can be called on an <code class="docutils literal notranslate"><span class="pre">EcephysSession</span></code> object, please review the original documentation for the <a href = 'https://allensdk.readthedocs.io/en/v1.7.1/allensdk.brain_observatory.ecephys.ecephys_session.html'> ecephys_session module</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Return units dataframe</span>
<span class="n">units_df</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">units</span>
<span class="n">units_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>waveform_duration</th>
      <th>cluster_id</th>
      <th>peak_channel_id</th>
      <th>cumulative_drift</th>
      <th>amplitude_cutoff</th>
      <th>snr</th>
      <th>waveform_recovery_slope</th>
      <th>isolation_distance</th>
      <th>nn_miss_rate</th>
      <th>silhouette_score</th>
      <th>...</th>
      <th>ecephys_structure_id</th>
      <th>ecephys_structure_acronym</th>
      <th>anterior_posterior_ccf_coordinate</th>
      <th>dorsal_ventral_ccf_coordinate</th>
      <th>left_right_ccf_coordinate</th>
      <th>probe_description</th>
      <th>location</th>
      <th>probe_sampling_rate</th>
      <th>probe_lfp_sampling_rate</th>
      <th>probe_has_lfp_data</th>
    </tr>
    <tr>
      <th>unit_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>950916730</th>
      <td>0.315913</td>
      <td>0</td>
      <td>850252273</td>
      <td>421.99</td>
      <td>0.010911</td>
      <td>2.408535</td>
      <td>-0.072013</td>
      <td>115.066739</td>
      <td>0.001010</td>
      <td>NaN</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8369.0</td>
      <td>3658.0</td>
      <td>6985.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916822</th>
      <td>0.233501</td>
      <td>7</td>
      <td>850252319</td>
      <td>294.57</td>
      <td>0.000025</td>
      <td>3.769478</td>
      <td>-0.212549</td>
      <td>160.983322</td>
      <td>0.000000</td>
      <td>0.115187</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8288.0</td>
      <td>3464.0</td>
      <td>7039.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916845</th>
      <td>0.192295</td>
      <td>9</td>
      <td>850252323</td>
      <td>270.88</td>
      <td>0.023245</td>
      <td>3.087942</td>
      <td>-0.216281</td>
      <td>77.035531</td>
      <td>0.002380</td>
      <td>0.170339</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8281.0</td>
      <td>3448.0</td>
      <td>7044.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916856</th>
      <td>0.233501</td>
      <td>10</td>
      <td>850252325</td>
      <td>219.19</td>
      <td>0.011552</td>
      <td>2.743504</td>
      <td>-0.087931</td>
      <td>291.708582</td>
      <td>0.047256</td>
      <td>0.141643</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8277.0</td>
      <td>3440.0</td>
      <td>7046.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916892</th>
      <td>0.343384</td>
      <td>13</td>
      <td>850252329</td>
      <td>558.87</td>
      <td>0.029890</td>
      <td>2.428990</td>
      <td>-0.005812</td>
      <td>41.639547</td>
      <td>0.000338</td>
      <td>0.180152</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8270.0</td>
      <td>3424.0</td>
      <td>7051.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 89 columns</p>
</div></div></div>
</div>
<p>To ensure that the recordings we use in our analysis are all reliable and of good quality, we will filter the data according to the signal-to-noise ratio (<code class="docutils literal notranslate"><span class="pre">snr</span></code>) and the <code class="docutils literal notranslate"><span class="pre">ISI_Violations</span></code> of our neurons. Below we will plot the distributions of both.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

<span class="c1"># Signal to noise distribution</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">units_df</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Signal to Noise Ratio&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>

<span class="c1"># ISI Violations</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">units_df</span><span class="p">[</span><span class="s1">&#39;isi_violations&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Rate of Refractory Period Violations&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Obtaining_Raw_Electrophysiology_Data_16_0.png" src="../_images/Obtaining_Raw_Electrophysiology_Data_16_0.png" />
</div>
</div>
<p>For the purposes of this tutorial, we will focus on units with <code class="docutils literal notranslate"><span class="pre">snr</span></code> values greater than 2 and <code class="docutils literal notranslate"><span class="pre">ISI_violation</span></code> values less than 0.1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create dataframe from units that fit criteria</span>
<span class="n">good_snr</span> <span class="o">=</span> <span class="n">units_df</span><span class="p">[</span><span class="n">units_df</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">]</span>
<span class="n">good_units_df</span> <span class="o">=</span> <span class="n">good_snr</span><span class="p">[</span><span class="n">good_snr</span><span class="p">[</span><span class="s1">&#39;isi_violations&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of units with good SNR and low ISI:&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">good_units_df</span><span class="p">))</span>
<span class="n">good_units_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of units with good SNR and low ISI: 488
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>waveform_duration</th>
      <th>cluster_id</th>
      <th>peak_channel_id</th>
      <th>cumulative_drift</th>
      <th>amplitude_cutoff</th>
      <th>snr</th>
      <th>waveform_recovery_slope</th>
      <th>isolation_distance</th>
      <th>nn_miss_rate</th>
      <th>silhouette_score</th>
      <th>...</th>
      <th>ecephys_structure_id</th>
      <th>ecephys_structure_acronym</th>
      <th>anterior_posterior_ccf_coordinate</th>
      <th>dorsal_ventral_ccf_coordinate</th>
      <th>left_right_ccf_coordinate</th>
      <th>probe_description</th>
      <th>location</th>
      <th>probe_sampling_rate</th>
      <th>probe_lfp_sampling_rate</th>
      <th>probe_has_lfp_data</th>
    </tr>
    <tr>
      <th>unit_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>950916730</th>
      <td>0.315913</td>
      <td>0</td>
      <td>850252273</td>
      <td>421.99</td>
      <td>0.010911</td>
      <td>2.408535</td>
      <td>-0.072013</td>
      <td>115.066739</td>
      <td>0.001010</td>
      <td>NaN</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8369.0</td>
      <td>3658.0</td>
      <td>6985.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916822</th>
      <td>0.233501</td>
      <td>7</td>
      <td>850252319</td>
      <td>294.57</td>
      <td>0.000025</td>
      <td>3.769478</td>
      <td>-0.212549</td>
      <td>160.983322</td>
      <td>0.000000</td>
      <td>0.115187</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8288.0</td>
      <td>3464.0</td>
      <td>7039.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916856</th>
      <td>0.233501</td>
      <td>10</td>
      <td>850252325</td>
      <td>219.19</td>
      <td>0.011552</td>
      <td>2.743504</td>
      <td>-0.087931</td>
      <td>291.708582</td>
      <td>0.047256</td>
      <td>0.141643</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8277.0</td>
      <td>3440.0</td>
      <td>7046.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950917034</th>
      <td>0.467002</td>
      <td>24</td>
      <td>850252351</td>
      <td>154.34</td>
      <td>0.003052</td>
      <td>2.084643</td>
      <td>-0.059217</td>
      <td>179.310426</td>
      <td>0.013169</td>
      <td>0.102770</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8229.0</td>
      <td>3331.0</td>
      <td>7079.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950916996</th>
      <td>0.192295</td>
      <td>21</td>
      <td>850252349</td>
      <td>184.14</td>
      <td>0.003787</td>
      <td>2.805553</td>
      <td>-0.221815</td>
      <td>68.033790</td>
      <td>0.003977</td>
      <td>0.054381</td>
      <td>...</td>
      <td>215.0</td>
      <td>APN</td>
      <td>8232.0</td>
      <td>3339.0</td>
      <td>7077.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 89 columns</p>
</div></div></div>
</div>
</div>
<div class="section" id="obtaining-single-action-potential-waveforms">
<h2><span class="section-number">3.2.3. </span>Obtaining Single Action Potential Waveforms<a class="headerlink" href="#obtaining-single-action-potential-waveforms" title="Permalink to this headline">¶</a></h2>
<p>Each session contains a dictionary of mean waveforms for all the units recorded in that session. They are stored inside a xarray DataArray where the <code class="docutils literal notranslate"><span class="pre">unit_id</span></code> are mapped to the mean spike waveform values. The dimensions of the DataArrays are <code class="docutils literal notranslate"><span class="pre">channel</span></code> and <code class="docutils literal notranslate"><span class="pre">time</span></code> which are recorded in microvolts and seconds, respectivley. For more information on <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code>, please visit the <a href = 'http://xarray.pydata.org/en/stable/generated/xarray.DataArray.html'> xarray original documentation</a>.</p>
<p>To access the mean spike waveforms for all units in a session, use the attribute <code class="docutils literal notranslate"><span class="pre">mean_waveforms</span></code> on your <code class="docutils literal notranslate"><span class="pre">EcephysSession</span></code> object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_mean_waveforms</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">mean_waveforms</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Total number of waveforms:&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">all_mean_waveforms</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total number of waveforms: 755
</pre></div>
</div>
</div>
</div>
<p>We can plot the mean waveforms of our units with the method <code class="docutils literal notranslate"><span class="pre">plot_mean_waveforms</span></code> from the ecephys visualization package. The method uses the <code class="docutils literal notranslate"><span class="pre">mean_waveforms</span></code> dictionary, <code class="docutils literal notranslate"><span class="pre">unit_id</span></code>’s, and <code class="docutils literal notranslate"><span class="pre">peak_channel_id</span></code>’s as arguments. For more information on this method, visit the <code class="docutils literal notranslate"><span class="pre">allensdk.brain_observatory.ecephys.visualization</span></code> package documentation on the <a href = 'https://allensdk.readthedocs.io/en/latest/allensdk.brain_observatory.ecephys.visualization.html'> Allen Brain Atlas website</a>.</p>
<p>Below we will compare mean waveforms from units of different brain areas. We will be looking at one wavefrom from the <code class="docutils literal notranslate"><span class="pre">CA1</span></code>, <code class="docutils literal notranslate"><span class="pre">LP</span></code>, <code class="docutils literal notranslate"><span class="pre">DG</span></code>, <code class="docutils literal notranslate"><span class="pre">VISp</span></code>. We first need to create a list of unit_id’s for the units we are interested in.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assign Unit IDs of different brain areas of interest</span>
<span class="n">CA1_unit_ids</span> <span class="o">=</span> <span class="n">good_units_df</span><span class="p">[</span><span class="n">good_units_df</span><span class="p">[</span><span class="s1">&#39;ecephys_structure_acronym&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CA1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">LP_unit_ids</span> <span class="o">=</span> <span class="n">good_units_df</span><span class="p">[</span><span class="n">good_units_df</span><span class="p">[</span><span class="s1">&#39;ecephys_structure_acronym&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;LP&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">DG_unit_ids</span> <span class="o">=</span> <span class="n">good_units_df</span><span class="p">[</span><span class="n">good_units_df</span><span class="p">[</span><span class="s1">&#39;ecephys_structure_acronym&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DG&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="n">VISp_unit_ids</span> <span class="o">=</span> <span class="n">good_units_df</span><span class="p">[</span><span class="n">good_units_df</span><span class="p">[</span><span class="s1">&#39;ecephys_structure_acronym&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;VISp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

<span class="c1"># Return first entry of our brain areas of interst</span>
<span class="n">first_CA1_units_ids</span> <span class="o">=</span> <span class="n">CA1_unit_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">first_LP_units_ids</span> <span class="o">=</span> <span class="n">LP_unit_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">first_DG_units_ids</span> <span class="o">=</span> <span class="n">DG_unit_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">first_VISp_units_ids</span> <span class="o">=</span> <span class="n">VISp_unit_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">uoi_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">first_CA1_units_ids</span><span class="p">,</span> <span class="n">first_LP_units_ids</span><span class="p">,</span> <span class="n">first_DG_units_ids</span><span class="p">,</span> <span class="n">first_VISp_units_ids</span><span class="p">]</span>

<span class="c1"># Return dataframe</span>
<span class="n">uoi_df</span> <span class="o">=</span> <span class="n">good_units_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">uoi_ids</span><span class="p">]</span>

<span class="n">uoi_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>waveform_duration</th>
      <th>cluster_id</th>
      <th>peak_channel_id</th>
      <th>cumulative_drift</th>
      <th>amplitude_cutoff</th>
      <th>snr</th>
      <th>waveform_recovery_slope</th>
      <th>isolation_distance</th>
      <th>nn_miss_rate</th>
      <th>silhouette_score</th>
      <th>...</th>
      <th>ecephys_structure_id</th>
      <th>ecephys_structure_acronym</th>
      <th>anterior_posterior_ccf_coordinate</th>
      <th>dorsal_ventral_ccf_coordinate</th>
      <th>left_right_ccf_coordinate</th>
      <th>probe_description</th>
      <th>location</th>
      <th>probe_sampling_rate</th>
      <th>probe_lfp_sampling_rate</th>
      <th>probe_has_lfp_data</th>
    </tr>
    <tr>
      <th>unit_id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>950918424</th>
      <td>0.288442</td>
      <td>124</td>
      <td>850252701</td>
      <td>138.64</td>
      <td>0.020835</td>
      <td>2.185120</td>
      <td>-0.039858</td>
      <td>90.797157</td>
      <td>0.001406</td>
      <td>0.102849</td>
      <td>...</td>
      <td>382.0</td>
      <td>CA1</td>
      <td>7767.0</td>
      <td>1620.0</td>
      <td>7511.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950924138</th>
      <td>0.302178</td>
      <td>221</td>
      <td>850249435</td>
      <td>132.03</td>
      <td>0.000049</td>
      <td>4.994113</td>
      <td>-0.187781</td>
      <td>124.487692</td>
      <td>0.000000</td>
      <td>0.218848</td>
      <td>...</td>
      <td>218.0</td>
      <td>LP</td>
      <td>7918.0</td>
      <td>2983.0</td>
      <td>7322.0</td>
      <td>probeB</td>
      <td>See electrode locations</td>
      <td>29999.918880</td>
      <td>1249.996620</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950918182</th>
      <td>0.315913</td>
      <td>105</td>
      <td>850252619</td>
      <td>112.89</td>
      <td>0.001606</td>
      <td>2.447300</td>
      <td>-0.087164</td>
      <td>75.802888</td>
      <td>0.009311</td>
      <td>0.044917</td>
      <td>...</td>
      <td>726.0</td>
      <td>DG</td>
      <td>7856.0</td>
      <td>2095.0</td>
      <td>7339.0</td>
      <td>probeA</td>
      <td>See electrode locations</td>
      <td>29999.967418</td>
      <td>1249.998642</td>
      <td>True</td>
    </tr>
    <tr>
      <th>950934565</th>
      <td>0.879062</td>
      <td>336</td>
      <td>850251321</td>
      <td>139.52</td>
      <td>0.000468</td>
      <td>2.959099</td>
      <td>-0.025951</td>
      <td>66.252958</td>
      <td>0.000239</td>
      <td>0.171097</td>
      <td>...</td>
      <td>385.0</td>
      <td>VISp</td>
      <td>8451.0</td>
      <td>1184.0</td>
      <td>7704.0</td>
      <td>probeC</td>
      <td>See electrode locations</td>
      <td>29999.997521</td>
      <td>1249.999897</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 89 columns</p>
</div></div></div>
</div>
<p>Using the <code class="docutils literal notranslate"><span class="pre">unit_ids</span></code>, we can create our own dictionary that maps our units of interest to their <code class="docutils literal notranslate"><span class="pre">mean_waveforms</span></code> array.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create dictionary of waveforms that only include units of interest</span>
<span class="n">waveforms_oi</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">uoi_ids</span><span class="p">:</span>
    <span class="n">waveforms_oi</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_mean_waveforms</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span>

<span class="c1"># Create dictionary of peak channels that only include units of interest</span>
<span class="n">peak_channels_oi</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">uoi_ids</span><span class="p">:</span>
    <span class="n">peak_channels_oi</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span> <span class="o">=</span> <span class="n">good_units_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ids</span><span class="p">,</span> <span class="s1">&#39;peak_channel_id&#39;</span><span class="p">]</span>

<span class="c1"># Plot mean waveforms</span>
<span class="n">ecvis</span><span class="o">.</span><span class="n">plot_mean_waveforms</span><span class="p">(</span><span class="n">waveforms_oi</span><span class="p">,</span> <span class="n">uoi_ids</span><span class="p">,</span> <span class="n">peak_channels_oi</span><span class="p">)</span>

<span class="n">legend_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">uoi_df</span><span class="p">[</span><span class="s1">&#39;ecephys_structure_acronym&#39;</span><span class="p">]</span> <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_list</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Obtaining_Raw_Electrophysiology_Data_25_0.png" src="../_images/Obtaining_Raw_Electrophysiology_Data_25_0.png" />
</div>
</div>
<div class="section" id="additional-resources">
<h3><span class="section-number">3.2.3.1. </span>Additional Resources<a class="headerlink" href="#additional-resources" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference external" href="https://allensdk.readthedocs.io/en/latest/_static/examples/nb/ecephys_session.html">Allen Institute Tutorial Notebook</a></p></li>
</ul>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Chapter_03"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="Visualizing_Large_Scale_Recordings.html" title="previous page"><span class="section-number">3.1. </span>Visualizing Large Scale Recordings</a>
    <a class='right-next' id="next-link" href="Aligning_Spike_Trains_with_Stimuli_and_Behavior.html" title="next page"><span class="section-number">3.3. </span>Aligning Spike Trains with Visual Stimuli and Behavior</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Victor Magdaleno-Garcia & Ashley Juavinett<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>