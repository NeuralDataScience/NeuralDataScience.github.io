
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6.2. Analyzing Two Photon Data &#8212; A Hands-On Guide to Neural Data Science</title>
    
  <link rel="stylesheet" href="../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.2d2078699c18a0efb88233928e1cf6ed.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.be0a4a0c39cd630af62a2fcf693f3f06.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6.3. Correlations in Two Photon Data" href="Correlations_in_Two_Photon_Data.html" />
    <link rel="prev" title="6.1. Retrieving Calcium Imaging Data" href="Retrieving_Brain_Observatory_Data.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/brainz.jpeg" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">A Hands-On Guide to Neural Data Science</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../landing_page.html">
   A Hands-On Guide to Neural Data Science
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_1/Neural_Data_Science.html">
   1. Neural Data Science
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_2/Data_Science_In_Python.html">
   2. Data Science in Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_3/Statistical_Concepts.html">
   3. Statistical Concepts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_4/Neurodata_Without_Borders.html">
   4. Neurodata Without Borders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_5/Single-Cell_Electrophysiology.html">
   5. Single-Cell Electrophysiology
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="reference internal" href="Two_Photon_Imaging.html">
   6. Two Photon Imaging
  </a>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="Retrieving_Brain_Observatory_Data.html">
     6.1. Retrieving Calcium Imaging Data
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     6.2. Analyzing Two Photon Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="Correlations_in_Two_Photon_Data.html">
     6.3. Correlations in Two Photon Data
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_7/Large_Scale_Electrophysiology.html">
   7. Large Scale Electrophysiology
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_8/Connectivity_Atlas.html">
   8. Allen Mouse Brain Connectivity Atlas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_9/Brain_Imaging_Data_Structures.html">
   9. Brain Imaging Data Structures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_10/Text_Analyses_of_Neuroscience_Literature.html">
   10. Text Analyses of Neuroscience Literature
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../Chapter_11/Approaches_to_Analyzing_Large_Datasets.html">
   11. Approaches to Analyzing Large Datasets
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/Chapter_6/Analyzing_Two_Photon_Data.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/NeuralDataScience/NeuralDataScience.github.io/master?urlpath=tree/Chapter_6/Analyzing_Two_Photon_Data.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/NeuralDataScience/NeuralDataScience.github.io/blob/master/Chapter_6/Analyzing_Two_Photon_Data.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#setup">
   6.2.1. Setup
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#download-inspect-the-natural-scenes-imaging-session">
   6.2.2. Download &amp; inspect the natural scenes imaging session
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#converting-calcium-imaging-into-spikes">
   6.2.3. Converting Calcium Imaging into Spikes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#look-at-the-response-of-your-cells-to-natural-scenes">
   6.2.4. Look at the response of your cells to natural scenes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#examine-the-direction-selectivity-of-your-cell">
   6.2.5. Examine the direction selectivity of your cell
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="analyzing-two-photon-data">
<h1><span class="section-number">6.2. </span>Analyzing Two Photon Data<a class="headerlink" href="#analyzing-two-photon-data" title="Permalink to this headline">¶</a></h1>
<p>On the previous page, we introduced how to retrieve specific experiments from the Allen Institute SDK’s Brain Observatory. Here we’ll introduce how researchers analyze this data, from processing single cell activity to understanding tuning curves.</p>
<div class="section" id="setup">
<h2><span class="section-number">6.2.1. </span>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>We need a variety of standard Python packages in addition to two different <code class="docutils literal notranslate"><span class="pre">allensdk</span></code> toolboxes. If you have not yet installed the <code class="docutils literal notranslate"><span class="pre">allensdk</span></code>, run the cell below. Otherwise, you can skip to the cell that imports our toolboxes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># This will ensure that the AllenSDK is installed.</span>
<span class="c1"># If not, it will install it for you.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">allensdk</span>
    <span class="k">if</span> <span class="n">allensdk</span><span class="o">.</span><span class="n">__version__</span> <span class="o">==</span> <span class="s1">&#39;2.11.2&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;allensdk already installed.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;incompatible version of allensdk installed&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="o">!</span>pip install allensdk
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>allensdk already installed.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Import toolboxes</span>
<span class="kn">from</span> <span class="nn">allensdk.core.brain_observatory_cache</span> <span class="kn">import</span> <span class="n">BrainObservatoryCache</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span> 
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span> 
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Packages imported.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Packages imported.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="download-inspect-the-natural-scenes-imaging-session">
<h2><span class="section-number">6.2.2. </span>Download &amp; inspect the natural scenes imaging session<a class="headerlink" href="#download-inspect-the-natural-scenes-imaging-session" title="Permalink to this headline">¶</a></h2>
<p>First, we’ll look at an experiment where the mouse viewed natural scenes. Below, we’ll assign an experiment container ID (the same one we worked with in the previous section), designate that we’re interested in only the natural scenes experiments, and download the data for the first experiment in the container.</p>
<p><strong>Note</strong>: The cell below downloads some data, and make take a minute or so to run. It is important that you do not interrupt the download of the data or else the file will become corrupted and you will have to delete it and try again.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create an instance of the Brain Observatory cache</span>
<span class="n">boc</span> <span class="o">=</span> <span class="n">BrainObservatoryCache</span><span class="p">(</span><span class="n">manifest_file</span><span class="o">=</span><span class="s1">&#39;manifest.json&#39;</span><span class="p">)</span>

<span class="c1"># Assign container ID from previous section</span>
<span class="n">exp_container_id</span> <span class="o">=</span> <span class="mi">627823571</span>
<span class="n">stim</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;natural_scenes&#39;</span><span class="p">]</span>

<span class="c1"># Get experiments for our container id and stimuli of interest</span>
<span class="n">experiments</span> <span class="o">=</span> <span class="n">boc</span><span class="o">.</span><span class="n">get_ophys_experiments</span><span class="p">(</span><span class="n">experiment_container_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_container_id</span><span class="p">],</span>
                                     <span class="n">stimuli</span> <span class="o">=</span> <span class="n">stim</span><span class="p">)</span>

<span class="c1"># Assign the experiment id </span>
<span class="n">experiment_id</span> <span class="o">=</span> <span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="n">experiment_data</span> <span class="o">=</span> <span class="n">boc</span><span class="o">.</span><span class="n">get_ophys_experiment_data</span><span class="p">(</span><span class="n">experiment_id</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data acquired.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data acquired.
</pre></div>
</div>
</div>
</div>
<p>Let’s take a quick look at the data you just downloaded. We’ll create a <strong>maximum projection image</strong> of the data, so that we can see the cells in our field of view. If we just looked at one snapshot of the raw imaging data, the cells would look dim – they only become bright when they’re actively firing. A maximum projection image shows us the maximum brightness for each pixel, across the entire experiment. Please visit the <a href = 'https://alleninstitute.github.io/AllenSDK/allensdk.core.brain_observatory_nwb_data_set.html'> Brain Observatory NWB Data Set documentation </a> for the original documentation to the methods used in the fluorescence imaging and natural scenes section.</p>
<p>Below, we are using the <code class="docutils literal notranslate"><span class="pre">get_max_projection()</span></code> method on our data, and then using the <code class="docutils literal notranslate"><span class="pre">imshow()</span></code> method in order to see our projection.</p>
<p><strong>Note</strong>: The weird text for the ylabel is called “TeX” markup, in order to get the greek symbol <em>mu</em> (<span class="math notranslate nohighlight">\(\mu\)</span>). See documentation on the <a href="https://matplotlib.org/tutorials/text/mathtext.html">matplotlib website</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the maximum projection (a numpy array) of our data</span>
<span class="n">max_projection</span> <span class="o">=</span> <span class="n">experiment_data</span><span class="o">.</span><span class="n">get_max_projection</span><span class="p">()</span>

<span class="c1"># Create a new figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># Use imshow to visualize our numpy array</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">max_projection</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

<span class="c1"># Add labels for microns; weird syntax below is to get the micro sign</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mu$m&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\mu$m&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Analyzing_Two_Photon_Data_6_0.png" src="../_images/Analyzing_Two_Photon_Data_6_0.png" />
</div>
</div>
</div>
<div class="section" id="converting-calcium-imaging-into-spikes">
<h2><span class="section-number">6.2.3. </span>Converting Calcium Imaging into Spikes<a class="headerlink" href="#converting-calcium-imaging-into-spikes" title="Permalink to this headline">¶</a></h2>
<p>Now we’ll plot the data of each of our cells (from the field of view above) across time. Each line shows the change in fluorescence over baseline (<span class="math notranslate nohighlight">\(\Delta\)</span>)F/F) of the individual cells. When there are sharp increases, that’s when the cells are responding.</p>
<p>In the example below, we will plot the first 10 cells from our data. the <code class="docutils literal notranslate"><span class="pre">get_dff_traces()</span></code> method returns the timestamps (in seconds) and deltaF/F.</p>
<p>Below, we’ve also added a line in our loop that offsets each cell by a predetermined amount so that we can see individual calcium traces. Each line is a different neuron, and the small blips in the data are calcium-mediated changes in fluorescence.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Assign timestamps and deltaF/F</span>
<span class="n">ts</span><span class="p">,</span> <span class="n">dff</span> <span class="o">=</span> <span class="n">experiment_data</span><span class="o">.</span><span class="n">get_dff_traces</span><span class="p">()</span>

<span class="c1"># Set up a figure</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># Loop through to add an offset on the y-axis</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">12</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">dff</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="p">)</span>
    <span class="n">offset</span><span class="o">+=</span><span class="mi">5</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Timestamp (s)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Neurons ($\Delta$F\F)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">2700</span><span class="p">,</span><span class="mi">2720</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Analyzing_Two_Photon_Data_9_0.png" src="../_images/Analyzing_Two_Photon_Data_9_0.png" />
</div>
</div>
</div>
<div class="section" id="look-at-the-response-of-your-cells-to-natural-scenes">
<h2><span class="section-number">6.2.4. </span>Look at the response of your cells to natural scenes<a class="headerlink" href="#look-at-the-response-of-your-cells-to-natural-scenes" title="Permalink to this headline">¶</a></h2>
<p>There are clearly some responses above, but it’s tough to see whether this corresponds to different behaviors or visual stimuli with just the raw fluorescence traces.</p>
<p>Let’s see how these cells actually responded to different types of images. To do so, we’ll need to use the <code class="docutils literal notranslate"><span class="pre">get_cell_specimens()</span></code> method on our <code class="docutils literal notranslate"><span class="pre">boc</span></code>, giving it the name of the experiment container ID.</p>
<p>The dataframe that this creates will have a lot more information about what the cells in our experiment prefer. Each row is a different cell, each with its own preferences and response patterns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the cell specimens information for this experiment</span>
<span class="n">cell_specimens</span> <span class="o">=</span> <span class="n">boc</span><span class="o">.</span><span class="n">get_cell_specimens</span><span class="p">(</span><span class="n">experiment_container_ids</span><span class="o">=</span><span class="p">[</span><span class="n">exp_container_id</span><span class="p">])</span>
<span class="n">cell_specimens_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cell_specimens</span><span class="p">)</span>
<span class="n">cell_specimens_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>all_stim</th>
      <th>area</th>
      <th>cell_specimen_id</th>
      <th>donor_full_genotype</th>
      <th>dsi_dg</th>
      <th>experiment_container_id</th>
      <th>failed_experiment_container</th>
      <th>g_dsi_dg</th>
      <th>g_osi_dg</th>
      <th>g_osi_sg</th>
      <th>...</th>
      <th>specimen_id</th>
      <th>tfdi_dg</th>
      <th>time_to_peak_ns</th>
      <th>time_to_peak_sg</th>
      <th>tld1_id</th>
      <th>tld1_name</th>
      <th>tld2_id</th>
      <th>tld2_name</th>
      <th>tlr1_id</th>
      <th>tlr1_name</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>VISp</td>
      <td>662199586</td>
      <td>Tlx3-Cre_PL56/wt;Ai148(TIT2L-GC6f-ICL-tTA2)/wt</td>
      <td>NaN</td>
      <td>627823571</td>
      <td>False</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>603751387</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>265180449</td>
      <td>Tlx3-Cre_PL56</td>
      <td>None</td>
      <td>None</td>
      <td>528393470</td>
      <td>Ai148(TIT2L-GC6f-ICL-tTA2)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>False</td>
      <td>VISp</td>
      <td>662199605</td>
      <td>Tlx3-Cre_PL56/wt;Ai148(TIT2L-GC6f-ICL-tTA2)/wt</td>
      <td>0.793449</td>
      <td>627823571</td>
      <td>False</td>
      <td>0.452460</td>
      <td>0.360264</td>
      <td>0.640623</td>
      <td>...</td>
      <td>603751387</td>
      <td>0.265616</td>
      <td>0.29916</td>
      <td>0.29916</td>
      <td>265180449</td>
      <td>Tlx3-Cre_PL56</td>
      <td>None</td>
      <td>None</td>
      <td>528393470</td>
      <td>Ai148(TIT2L-GC6f-ICL-tTA2)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>True</td>
      <td>VISp</td>
      <td>662199626</td>
      <td>Tlx3-Cre_PL56/wt;Ai148(TIT2L-GC6f-ICL-tTA2)/wt</td>
      <td>0.346550</td>
      <td>627823571</td>
      <td>False</td>
      <td>0.346134</td>
      <td>0.107403</td>
      <td>0.943987</td>
      <td>...</td>
      <td>603751387</td>
      <td>0.393678</td>
      <td>0.29916</td>
      <td>0.33240</td>
      <td>265180449</td>
      <td>Tlx3-Cre_PL56</td>
      <td>None</td>
      <td>None</td>
      <td>528393470</td>
      <td>Ai148(TIT2L-GC6f-ICL-tTA2)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>False</td>
      <td>VISp</td>
      <td>662199645</td>
      <td>Tlx3-Cre_PL56/wt;Ai148(TIT2L-GC6f-ICL-tTA2)/wt</td>
      <td>0.636332</td>
      <td>627823571</td>
      <td>False</td>
      <td>0.629502</td>
      <td>0.971795</td>
      <td>NaN</td>
      <td>...</td>
      <td>603751387</td>
      <td>0.357068</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>265180449</td>
      <td>Tlx3-Cre_PL56</td>
      <td>None</td>
      <td>None</td>
      <td>528393470</td>
      <td>Ai148(TIT2L-GC6f-ICL-tTA2)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>False</td>
      <td>VISp</td>
      <td>662199683</td>
      <td>Tlx3-Cre_PL56/wt;Ai148(TIT2L-GC6f-ICL-tTA2)/wt</td>
      <td>NaN</td>
      <td>627823571</td>
      <td>False</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.524082</td>
      <td>...</td>
      <td>603751387</td>
      <td>NaN</td>
      <td>0.29916</td>
      <td>0.33240</td>
      <td>265180449</td>
      <td>Tlx3-Cre_PL56</td>
      <td>None</td>
      <td>None</td>
      <td>528393470</td>
      <td>Ai148(TIT2L-GC6f-ICL-tTA2)</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 60 columns</p>
</div></div></div>
</div>
<p>Let’s create a bar graph of preferred images in our dataset. The <code class="docutils literal notranslate"><span class="pre">p_ns</span></code> column contains the pvalue that corresponds to whether a cell <em>significantly</em> prefered an image more than the rest. We will use this column to subset our <code class="docutils literal notranslate"><span class="pre">cell_specimens_df</span></code> dataframe to only contains cells that have a p value less than 0.05.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pref_image_ns</span></code> column contains the image IDs of the stimulus being presented. We can create our bar graph from this column to see how many cells responded to these statistically significant images.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Subset dataframe to contain significantly preferred images </span>
<span class="n">col_1</span> <span class="o">=</span> <span class="s1">&#39;p_ns&#39;</span>
<span class="n">sig_cells</span> <span class="o">=</span> <span class="n">cell_specimens_df</span><span class="p">[</span><span class="n">cell_specimens_df</span><span class="p">[</span><span class="n">col_1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">]</span>

<span class="c1"># Assign our image ids for significantly preferred images</span>
<span class="n">col_2</span> <span class="o">=</span> <span class="s1">&#39;pref_image_ns&#39;</span>
<span class="n">pref_images</span> <span class="o">=</span> <span class="n">sig_cells</span><span class="p">[</span><span class="n">col_2</span><span class="p">]</span>

<span class="c1"># Set up our figure </span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot our bar graph</span>
<span class="n">pref_counts</span> <span class="o">=</span> <span class="n">pref_images</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
<span class="n">pref_counts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Response of cells to natural scenes&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of cells&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Image ID&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Analyzing_Two_Photon_Data_13_0.png" src="../_images/Analyzing_Two_Photon_Data_13_0.png" />
</div>
</div>
<p>In order to actually see what these images are, first, we’ll organize the stimulus table. This tells us which stimulus was played on each trial. This data set has 118 different scenes, and each scene is presented 50 times. Images of the scenes can be found <a class="reference external" href="http://observatory.brain-map.org/visualcoding/stimulus/natural_scenes">here</a>.</p>
<p>Below, we’ll show the top five images for cells in this field of view. Do they have anything in common, either visually or conceptually?</p>
<p><em>Note</em>: Not every experiment contains the data for the natural scenes experiment. If you change the experiment ID above and try the next cell, you may receive an error. You can use <code class="docutils literal notranslate"><span class="pre">data.list_stimuli()</span></code> to see all of the stimuli available within your experiment.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the natural scene information</span>
<span class="n">natural_scene_table</span> <span class="o">=</span> <span class="n">experiment_data</span><span class="o">.</span><span class="n">get_stimulus_table</span><span class="p">(</span><span class="s1">&#39;natural_scenes&#39;</span><span class="p">)</span>
<span class="n">natural_scene_template</span> <span class="o">=</span> <span class="n">experiment_data</span><span class="o">.</span><span class="n">get_stimulus_template</span><span class="p">(</span><span class="s1">&#39;natural_scenes&#39;</span><span class="p">)</span>
<span class="n">sceneIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">natural_scene_table</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>

<span class="c1"># Set up our figure</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">image_ID</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># Show the first 5 images</span>
    
    <span class="n">image_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pref_counts</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">image_ID</span><span class="p">])</span> <span class="c1"># Get the image ID</span>

    <span class="c1"># Use imshow to visualize our numpy array</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">image_ID</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">natural_scene_template</span><span class="p">[</span><span class="n">image_id</span><span class="p">,:,:],</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">image_ID</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">image_ID</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">image_ID</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Image &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">image_id</span><span class="p">))</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Analyzing_Two_Photon_Data_15_0.png" src="../_images/Analyzing_Two_Photon_Data_15_0.png" />
</div>
</div>
</div>
<div class="section" id="examine-the-direction-selectivity-of-your-cell">
<h2><span class="section-number">6.2.5. </span>Examine the direction selectivity of your cell<a class="headerlink" href="#examine-the-direction-selectivity-of-your-cell" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, the function of a cell is not particularly clear from natural stimuli. Those stimuli have a lot of information in them, and it might be hard to tell what a cell is actually responding to. Instead, we can use simple drifting gratings to look at one straightforward property of a cell: <b>does it respond to specific directions of movement?</b></br> To do so, we’ll examine the <strong>drifting gratings</strong> experiments.</p>
<p>We will now show how to plot a heatmap of a cell’s response organized by orientation and temporal frequency. We will be using one of the three cells from the dataframe above which showed direction selectivity from the significantly preferred images. Please visit the <a href = 'https://allensdk.readthedocs.io/en/latest/allensdk.brain_observatory.drifting_gratings.html'> Drifting Gratings module documentation </a> for additional help on the methods used in the drifting gratings section.</p>
<p>Below, we’ll use the same experiment container but a different stimulus to create a separate experiment dataset, <code class="docutils literal notranslate"><span class="pre">dg_experiment</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get experiment for our container id and stimuli of interest</span>
<span class="n">stim_2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;drifting_gratings&#39;</span><span class="p">]</span>
<span class="n">dg_experiment</span> <span class="o">=</span> <span class="n">boc</span><span class="o">.</span><span class="n">get_ophys_experiments</span><span class="p">(</span>
                        <span class="n">experiment_container_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">exp_container_id</span><span class="p">],</span>
                        <span class="n">stimuli</span> <span class="o">=</span> <span class="n">stim_2</span><span class="p">)</span>

<span class="c1"># Download the experiment data using the experiment id</span>
<span class="n">experiment_id_2</span> <span class="o">=</span> <span class="n">dg_experiment</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
<span class="n">data_dg</span> <span class="o">=</span> <span class="n">boc</span><span class="o">.</span><span class="n">get_ophys_experiment_data</span><span class="p">(</span><span class="n">experiment_id_2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Data acquired.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data acquired.
</pre></div>
</div>
</div>
</div>
<p>Our first step is to create an instance of our DriftingGratings object. The DriftingGratings class requires an NWB data set as an input (i.e. <code class="docutils literal notranslate"><span class="pre">data_dg</span></code>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">peak</span></code> property of the DriftingGratings object returns a Pandas DataFrame of peak conditions (direction and temporal frequency) as well as computed response metrics. Some key columns is this dataframe are the preferred orientation, <code class="docutils literal notranslate"><span class="pre">ori_dg</span></code>, and preferred frequency, <code class="docutils literal notranslate"><span class="pre">tf_dg</span></code>, of the cell. Other computed metrics include:</p>
<ul class="simple">
<li><p>reliability_dg</p></li>
<li><p>osi_dg (orientation selectivity index)</p></li>
<li><p>dsi_dg (direction selectivity index)</p></li>
<li><p>peak_dff_dg (peak dF/F)</p></li>
<li><p>ptest_dg (number of signficant cells)</p></li>
<li><p>p_run_dg (K-S statistic comparing running trials to stationary trials)</p></li>
<li><p>run_modulation_dg</p></li>
<li><p>cv_dg (circular variance)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">allensdk.brain_observatory.drifting_gratings</span> <span class="kn">import</span> <span class="n">DriftingGratings</span>

<span class="c1"># Create my DriftingGratings Object </span>
<span class="n">dg</span> <span class="o">=</span> <span class="n">DriftingGratings</span><span class="p">(</span><span class="n">data_dg</span><span class="p">)</span>

<span class="c1"># Return dataframe of peak conditions</span>
<span class="n">dg_df</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">peak</span>
<span class="n">dg_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="n">a78f67bdedb9</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> 
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="c1"># Return dataframe of peak conditions</span>
<span class="ne">----&gt; </span><span class="mi">7</span> <span class="n">dg_df</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">peak</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="n">dg_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

<span class="nn">~/opt/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/stimulus_analysis.py</span> in <span class="ni">peak</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span>     <span class="k">def</span> <span class="nf">peak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak</span> <span class="ow">is</span> <span class="n">StimulusAnalysis</span><span class="o">.</span><span class="n">_PRELOAD</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">136</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_peak</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_peak</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">137</span> 
<span class="g g-Whitespace">    </span><span class="mi">138</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_peak</span>

<span class="nn">~/opt/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/drifting_gratings.py</span> in <span class="ni">get_peak</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">167</span>         <span class="n">orivals_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orivals</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">168</span>         <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numbercells</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">169</span>             <span class="n">cell_peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="n">nc</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">170</span>                 <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="n">nc</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="g g-Whitespace">    </span><span class="mi">171</span>             <span class="n">prefori</span> <span class="o">=</span> <span class="n">cell_peak</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

<span class="nn">~/opt/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/stimulus_analysis.py</span> in <span class="ni">response</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">127</span>     <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">128</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="ow">is</span> <span class="n">StimulusAnalysis</span><span class="o">.</span><span class="n">_PRELOAD</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">129</span>             <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span> 
<span class="g g-Whitespace">    </span><span class="mi">131</span>         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span>

<span class="nn">~/opt/anaconda3/lib/python3.7/site-packages/allensdk/brain_observatory/drifting_gratings.py</span> in <span class="ni">get_response</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">130</span>                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_table</span><span class="o">.</span><span class="n">temporal_frequency</span> <span class="o">==</span> <span class="n">tf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_table</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="n">ori</span><span class="p">)]</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span>                 <span class="n">subset_pval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pval</span><span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_table</span><span class="o">.</span><span class="n">temporal_frequency</span> <span class="o">==</span> <span class="n">tf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">132</span>                     <span class="bp">self</span><span class="o">.</span><span class="n">stim_table</span><span class="o">.</span><span class="n">orientation</span> <span class="o">==</span> <span class="n">ori</span><span class="p">)]</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span>                 <span class="n">response</span><span class="p">[</span><span class="n">ori_pt</span><span class="p">,</span> <span class="n">tf_pt</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">subset_response</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span>                 <span class="n">response</span><span class="p">[</span><span class="n">ori_pt</span><span class="p">,</span> <span class="n">tf_pt</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">subset_response</span><span class="o">.</span><span class="n">std</span><span class="p">(</span>

<span class="nn">~/opt/anaconda3/lib/python3.7/site-packages/pandas/core/ops/__init__.py</span> in <span class="ni">wrapper</span><span class="nt">(self, other)</span>
<span class="g g-Whitespace">   </span><span class="mi">1320</span>         <span class="n">filler</span> <span class="o">=</span> <span class="n">fill_int</span> <span class="k">if</span> <span class="n">is_self_int_dtype</span> <span class="ow">and</span> <span class="n">is_other_int_dtype</span> <span class="k">else</span> <span class="n">fill_bool</span>
<span class="g g-Whitespace">   </span><span class="mi">1321</span>         <span class="n">res_values</span> <span class="o">=</span> <span class="n">na_op</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">ovalues</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1322</span>         <span class="n">unfilled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span><span class="n">res_values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">res_name</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1323</span>         <span class="n">filled</span> <span class="o">=</span> <span class="n">filler</span><span class="p">(</span><span class="n">unfilled</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1324</span>         <span class="k">return</span> <span class="n">finalizer</span><span class="p">(</span><span class="n">filled</span><span class="p">)</span>

<span class="nn">~/opt/anaconda3/lib/python3.7/site-packages/pandas/core/series.py</span> in <span class="ni">__init__</span><span class="nt">(self, data, index, dtype, name, copy, fastpath)</span>
<span class="g g-Whitespace">    </span><span class="mi">312</span>                     <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>             <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">314</span>                 <span class="n">data</span> <span class="o">=</span> <span class="n">sanitize_array</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">raise_cast_failure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">315</span> 
<span class="g g-Whitespace">    </span><span class="mi">316</span>                 <span class="n">data</span> <span class="o">=</span> <span class="n">SingleBlockManager</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">fastpath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nn">~/opt/anaconda3/lib/python3.7/site-packages/pandas/core/internals/construction.py</span> in <span class="ni">sanitize_array</span><span class="nt">(data, index, dtype, copy, raise_cast_failure)</span>
<span class="g g-Whitespace">    </span><span class="mi">662</span>         <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">663</span>             <span class="c1"># we will try to copy be-definition here</span>
<span class="ne">--&gt; </span><span class="mi">664</span>             <span class="n">subarr</span> <span class="o">=</span> <span class="n">_try_cast</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">raise_cast_failure</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">665</span> 
<span class="g g-Whitespace">    </span><span class="mi">666</span>     <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ExtensionArray</span><span class="p">):</span>

<span class="nn">~/opt/anaconda3/lib/python3.7/site-packages/pandas/core/internals/construction.py</span> in <span class="ni">_try_cast</span><span class="nt">(arr, dtype, copy, raise_cast_failure)</span>
<span class="g g-Whitespace">    </span><span class="mi">773</span>     <span class="c1"># perf shortcut as this is the most common case</span>
<span class="g g-Whitespace">    </span><span class="mi">774</span>     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">775</span>         <span class="k">if</span> <span class="n">maybe_castable</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">copy</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">776</span>             <span class="k">return</span> <span class="n">arr</span>
<span class="g g-Whitespace">    </span><span class="mi">777</span> 

<span class="nn">~/opt/anaconda3/lib/python3.7/site-packages/pandas/core/dtypes/cast.py</span> in <span class="ni">maybe_castable</span><span class="nt">(arr)</span>
<span class="g g-Whitespace">    </span><span class="mi">875</span>         <span class="k">return</span> <span class="n">is_timedelta64_ns_dtype</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">876</span> 
<span class="ne">--&gt; </span><span class="mi">877</span>     <span class="k">return</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_POSSIBLY_CAST_DTYPES</span>
<span class="g g-Whitespace">    </span><span class="mi">878</span> 
<span class="g g-Whitespace">    </span><span class="mi">879</span> 

<span class="nn">~/opt/anaconda3/lib/python3.7/site-packages/numpy/core/_dtype.py</span> in <span class="ni">_name_get</span><span class="nt">(dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span> 
<span class="g g-Whitespace">    </span><span class="mi">332</span> 
<span class="ne">--&gt; </span><span class="mi">333</span> <span class="k">def</span> <span class="nf">_name_get</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">334</span>     <span class="c1"># provides dtype.name.__get__, documented as returning a &quot;bit name&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">335</span> 

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>Next, we’ll select a cell from our table by <code class="docutils literal notranslate"><span class="pre">cell_specimen_id</span></code>.</p>
<p>If there is a specific cell you want to analyze, you can use the <code class="docutils literal notranslate"><span class="pre">get_cell_specimen_indices()</span></code> method to locate the index of your cell of interest. The index of your cell is needed becasue you will need to index into the NumPy arrary returned by the <code class="docutils literal notranslate"><span class="pre">response</span></code> attribute to contruct your heatmap.</p>
<p>Below, we’ll simply grab the first <code class="docutils literal notranslate"><span class="pre">cell_specimen_id</span></code> in our table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select specimen ID from first row</span>
<span class="n">specimen_id</span> <span class="o">=</span> <span class="n">dg_df</span><span class="p">[</span><span class="s1">&#39;cell_specimen_id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cell_loc</span> <span class="o">=</span> <span class="n">data_dg</span><span class="o">.</span><span class="n">get_cell_specimen_indices</span><span class="p">([</span><span class="n">specimen_id</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Specimen ID:&#39;</span><span class="p">,</span> <span class="n">specimen_id</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Cell loc:&#39;</span><span class="p">,</span> <span class="n">cell_loc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Specimen ID: 662201985
Cell loc: 0
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">response</span></code> attribute returns a 4-D NumPy array with the mean responses to each stimulus condition. The 1st column in the returned NumPy array contains mean responses to the orientations, the 2nd column contains mean responses to the temporal frequencies, the 3rd column contains the number of the cell, and the 4th column contains the response mean to column 1, the response standard error of the mean of column 2, and the number of signficant trials.</p>
<p>Below, we’ll use <code class="docutils literal notranslate"><span class="pre">plt.imshow()</span></code> to plot the mean responses across orientation and frequency, skipping the blank sweep column (0).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot our data, skiping the blank sweep column (0) of the temporal frequency dimension</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">dg</span><span class="o">.</span><span class="n">response</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:,</span><span class="n">cell_loc</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;hot&#39;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Heat Map, Cell Specimen: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">specimen_id</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">dg</span><span class="o">.</span><span class="n">tfvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">dg</span><span class="o">.</span><span class="n">orivals</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Temporal frequency (Hz)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Direction (deg)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;$\Delta$F/F (%)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/Analyzing_Two_Photon_Data_23_0.png" src="../_images/Analyzing_Two_Photon_Data_23_0.png" />
</div>
</div>
<p>The preferred directions temporal frequency are stored within <code class="docutils literal notranslate"><span class="pre">ori_dg</span></code> and <code class="docutils literal notranslate"><span class="pre">tf_dg</span></code> in are table above and can be indexed through <code class="docutils literal notranslate"><span class="pre">dg.orivals</span></code> and <code class="docutils literal notranslate"><span class="pre">tf.tfvals</span></code> respectively.</p>
<p>For more explanation on the available pre-computed metrics, please see <a href = 'https://alleninstitute.github.io/AllenSDK/_static/examples/nb/brain_observatory_analysis.html#Drifting-Gratings'> here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pref_ori</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">orivals</span><span class="p">[</span><span class="n">dg</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">ori_dg</span><span class="p">[</span><span class="n">cell_loc</span><span class="p">]]</span>
<span class="n">pref_tf</span> <span class="o">=</span> <span class="n">dg</span><span class="o">.</span><span class="n">tfvals</span><span class="p">[</span><span class="n">dg</span><span class="o">.</span><span class="n">peak</span><span class="o">.</span><span class="n">tf_dg</span><span class="p">[</span><span class="n">cell_loc</span><span class="p">]]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preferred direction:&quot;</span><span class="p">,</span> <span class="n">pref_ori</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preferred temporal frequency:&quot;</span><span class="p">,</span> <span class="n">pref_tf</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Preferred direction: 225
Preferred temporal frequency: 1
</pre></div>
</div>
</div>
</div>
<p>It is important to not that these are no the only possible analyses that can be done. We could go a step further and also look at the static gratings. We could plot the running speed of the mouse versus the DF/F of our cells to determine what stimlus elicited the fasted response from our mice. We can even use the data to determine the on and off receptive fields all our cells. In the analyses that we performed above we only looked at one experiment container that included one brain area and one cre line, but we are not limited to this and can compare brain areas and cre lines and can begin forming connections between differnt brain regions.</p>
<p>In conclusion, there are many different analyses that you can perform with the two photon imaging data. It is important to look through the downloaded data to ensure your desired brain regions, cre lines, and computed metrics are all availabed before beginning your work.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Chapter_6"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="Retrieving_Brain_Observatory_Data.html" title="previous page"><span class="section-number">6.1. </span>Retrieving Calcium Imaging Data</a>
    <a class='right-next' id="next-link" href="Correlations_in_Two_Photon_Data.html" title="next page"><span class="section-number">6.3. </span>Correlations in Two Photon Data</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Victor Magdaleno-Garcia<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>